<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Whiskers">
  <meta name="theme-color" content="#FF8B5E">
  <title>Whiskers Learning Companion</title>
  <link rel="manifest" href="manifest.json">
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.1.1/dist/tesseract.min.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body, #root { 
      width: 100%; 
      height: 100%; 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      overflow: hidden;
      touch-action: manipulation;
    }
    @keyframes blink { 0%, 50% { opacity: 1; } 51%, 100% { opacity: 0; } }
    @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-8px); } }
    @keyframes sparkle { 0%, 100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.7; transform: scale(1.2); } }
    @keyframes bounce { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
    @keyframes slideUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    @keyframes pulse { 0%, 100% { box-shadow: 0 0 0 0 rgba(255,139,94,0.4); } 50% { box-shadow: 0 0 0 15px rgba(255,139,94,0); } }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect, useRef, useCallback, createContext, useContext } = React;

    // ============================================================
    // CONFIGURATION - SET YOUR API KEYS HERE
    // ============================================================
    const CONFIG = {
      // OpenAI API Key (for ChatGPT) - get from platform.openai.com
      OPENAI_API_KEY: '',
      
      // ElevenLabs API Key (for realistic voice) - get from elevenlabs.io
      ELEVENLABS_API_KEY: '',
      
      // ElevenLabs Voice ID - some good kid-friendly options:
      // 'EXAVITQu4vr4xnSDxMaL' = Sarah (soft female)
      // 'MF3mGyEYCl7XYWbV9V6O' = Elli (cheerful young female)
      // '21m00Tcm4TlvDq8ikWAM' = Rachel (calm female)
      ELEVENLABS_VOICE_ID: 'EXAVITQu4vr4xnSDxMaL',
      
      // Set to false once you add API keys
      USE_DEMO_MODE: true,
      
      // Voice settings
      USE_ELEVENLABS: false // Set to true when you add ElevenLabs key
    };
    // ============================================================

    // ============== SETTINGS CONTEXT ==============
    const SettingsContext = createContext();

    const useSettings = () => useContext(SettingsContext);

    const SettingsProvider = ({ children }) => {
      const [settings, setSettings] = useState(() => {
        try {
          const saved = localStorage.getItem('whiskers_settings');
          return saved ? JSON.parse(saved) : {
            openaiKey: '',
            elevenlabsKey: '',
            elevenlabsVoiceId: 'EXAVITQu4vr4xnSDxMaL',
            language: 'en',
            useElevenlabs: false,
            useDemoMode: true
          };
        } catch {
          return {
            openaiKey: '',
            elevenlabsKey: '',
            elevenlabsVoiceId: 'EXAVITQu4vr4xnSDxMaL',
            language: 'en',
            useElevenlabs: false,
            useDemoMode: true
          };
        }
      });

      const updateSettings = (newSettings) => {
        const updated = { ...settings, ...newSettings };
        setSettings(updated);
        localStorage.setItem('whiskers_settings', JSON.stringify(updated));
      };

      return (
        <SettingsContext.Provider value={{ settings, updateSettings }}>
          {children}
        </SettingsContext.Provider>
      );
    };

    // ============== ANIMATED CAT COMPONENT ==============
    const WhiskersCat = ({ mood = 'happy', size = 200, isTalking = false }) => {
      const [blinkOpen, setBlinkOpen] = useState(true);
      const [tailAngle, setTailAngle] = useState(0);
      const [breathScale, setBreathScale] = useState(1);
      const [mouthOpen, setMouthOpen] = useState(false);
      const [bounceY, setBounceY] = useState(0);
      
      useEffect(() => {
        const blinkInterval = setInterval(() => {
          setBlinkOpen(false);
          setTimeout(() => setBlinkOpen(true), 150);
        }, 3000 + Math.random() * 2000);
        return () => clearInterval(blinkInterval);
      }, []);
      
      useEffect(() => {
        let frame = 0;
        const tailInterval = setInterval(() => {
          frame += 0.12;
          setTailAngle(Math.sin(frame) * 18);
        }, 50);
        return () => clearInterval(tailInterval);
      }, []);
      
      useEffect(() => {
        let frame = 0;
        const breathInterval = setInterval(() => {
          frame += 0.06;
          setBreathScale(1 + Math.sin(frame) * 0.025);
        }, 50);
        return () => clearInterval(breathInterval);
      }, []);
      
      useEffect(() => {
        if (isTalking) {
          const talkInterval = setInterval(() => setMouthOpen(prev => !prev), 120);
          return () => clearInterval(talkInterval);
        }
        setMouthOpen(false);
      }, [isTalking]);
      
      useEffect(() => {
        if (mood === 'excited' || mood === 'celebrating') {
          let frame = 0;
          const bounceInterval = setInterval(() => {
            frame += 0.25;
            setBounceY(Math.abs(Math.sin(frame)) * 12);
          }, 50);
          return () => clearInterval(bounceInterval);
        }
        setBounceY(0);
      }, [mood]);
      
      const catOrange = '#FF9B5E';
      const catCream = '#FFF5E6';
      const catStripe = '#E8855A';
      const noseColor = '#FFB5B5';
      
      const renderEyes = () => {
        const eyeY = 55;
        const leftEyeX = 70;
        const rightEyeX = 130;
        
        if (!blinkOpen) {
          return (
            <>
              <path d={`M ${leftEyeX - 12} ${eyeY} Q ${leftEyeX} ${eyeY + 8} ${leftEyeX + 12} ${eyeY}`} 
                    stroke="#333" strokeWidth="3" fill="none" strokeLinecap="round"/>
              <path d={`M ${rightEyeX - 12} ${eyeY} Q ${rightEyeX} ${eyeY + 8} ${rightEyeX + 12} ${eyeY}`} 
                    stroke="#333" strokeWidth="3" fill="none" strokeLinecap="round"/>
            </>
          );
        }
        
        if (mood === 'happy' || mood === 'celebrating') {
          return (
            <>
              <path d={`M ${leftEyeX - 12} ${eyeY + 5} Q ${leftEyeX} ${eyeY - 12} ${leftEyeX + 12} ${eyeY + 5}`} 
                    stroke="#333" strokeWidth="4" fill="none" strokeLinecap="round"/>
              <path d={`M ${rightEyeX - 12} ${eyeY + 5} Q ${rightEyeX} ${eyeY - 12} ${rightEyeX + 12} ${eyeY + 5}`} 
                    stroke="#333" strokeWidth="4" fill="none" strokeLinecap="round"/>
            </>
          );
        }
        
        if (mood === 'excited') {
          return (
            <>
              <circle cx={leftEyeX} cy={eyeY} r="14" fill="#333"/>
              <circle cx={leftEyeX - 3} cy={eyeY - 4} r="5" fill="white"/>
              <circle cx={leftEyeX + 5} cy={eyeY + 3} r="3" fill="white"/>
              <circle cx={rightEyeX} cy={eyeY} r="14" fill="#333"/>
              <circle cx={rightEyeX - 3} cy={eyeY - 4} r="5" fill="white"/>
              <circle cx={rightEyeX + 5} cy={eyeY + 3} r="3" fill="white"/>
            </>
          );
        }
        
        if (mood === 'thinking') {
          return (
            <>
              <ellipse cx={leftEyeX} cy={eyeY - 3} rx="10" ry="12" fill="white"/>
              <ellipse cx={leftEyeX + 4} cy={eyeY - 3} rx="6" ry="8" fill="#333"/>
              <circle cx={leftEyeX + 2} cy={eyeY - 5} r="2" fill="white"/>
              <ellipse cx={rightEyeX} cy={eyeY - 3} rx="10" ry="12" fill="white"/>
              <ellipse cx={rightEyeX + 4} cy={eyeY - 3} rx="6" ry="8" fill="#333"/>
              <circle cx={rightEyeX + 2} cy={eyeY - 5} r="2" fill="white"/>
            </>
          );
        }
        
        return (
          <>
            <ellipse cx={leftEyeX} cy={eyeY} rx="12" ry="14" fill="white"/>
            <ellipse cx={leftEyeX + 2} cy={eyeY} rx="8" ry="10" fill="#333"/>
            <circle cx={leftEyeX - 1} cy={eyeY - 3} r="3" fill="white"/>
            <ellipse cx={rightEyeX} cy={eyeY} rx="12" ry="14" fill="white"/>
            <ellipse cx={rightEyeX + 2} cy={eyeY} rx="8" ry="10" fill="#333"/>
            <circle cx={rightEyeX - 1} cy={eyeY - 3} r="3" fill="white"/>
          </>
        );
      };
      
      return (
        <svg 
          width={size} 
          height={size} 
          viewBox="0 0 200 200"
          style={{ 
            transform: `translateY(${-bounceY}px) scale(${breathScale})`,
            transition: 'transform 0.1s ease-out'
          }}
        >
          {mood === 'celebrating' && (
            <circle cx="100" cy="110" r="90" fill="url(#glowGradient)" opacity="0.6"/>
          )}
          
          <defs>
            <radialGradient id="glowGradient">
              <stop offset="0%" stopColor="#FFE566" stopOpacity="0.9"/>
              <stop offset="100%" stopColor="#FFE566" stopOpacity="0"/>
            </radialGradient>
          </defs>
          
          <g transform={`rotate(${tailAngle}, 150, 160)`}>
            <path d="M 145 155 Q 180 140 185 100 Q 190 80 175 70" 
                  stroke={catOrange} strokeWidth="18" fill="none" strokeLinecap="round"/>
            <path d="M 175 75 Q 172 68 178 65" 
                  stroke={catStripe} strokeWidth="6" fill="none" strokeLinecap="round"/>
          </g>
          
          <ellipse cx="100" cy="150" rx="55" ry="40" fill={catOrange}/>
          <ellipse cx="100" cy="155" rx="40" ry="28" fill={catCream}/>
          <ellipse cx="100" cy="75" rx="55" ry="50" fill={catOrange}/>
          
          <polygon points="45,45 55,0 80,35" fill={catOrange}/>
          <polygon points="55,35 60,15 72,32" fill={noseColor}/>
          <polygon points="155,45 145,0 120,35" fill={catOrange}/>
          <polygon points="145,35 140,15 128,32" fill={noseColor}/>
          
          <path d="M 85 25 Q 100 35 115 25" stroke={catStripe} strokeWidth="4" fill="none" strokeLinecap="round"/>
          <path d="M 90 35 Q 100 42 110 35" stroke={catStripe} strokeWidth="3" fill="none" strokeLinecap="round"/>
          
          <ellipse cx="100" cy="85" rx="35" ry="30" fill={catCream}/>
          {renderEyes()}
          <ellipse cx="100" cy="78" rx="8" ry="6" fill={noseColor}/>
          
          <path d={`M 100 84 L 100 ${mouthOpen ? 98 : 92}`} stroke="#333" strokeWidth="2"/>
          {mouthOpen ? (
            <ellipse cx="100" cy="96" rx="12" ry="8" fill="#FF8888"/>
          ) : (
            <>
              <path d="M 100 92 Q 88 100 82 95" stroke="#333" strokeWidth="2" fill="none"/>
              <path d="M 100 92 Q 112 100 118 95" stroke="#333" strokeWidth="2" fill="none"/>
            </>
          )}
          
          <line x1="45" y1="75" x2="20" y2="68" stroke="#333" strokeWidth="2"/>
          <line x1="45" y1="82" x2="18" y2="82" stroke="#333" strokeWidth="2"/>
          <line x1="45" y1="89" x2="20" y2="96" stroke="#333" strokeWidth="2"/>
          <line x1="155" y1="75" x2="180" y2="68" stroke="#333" strokeWidth="2"/>
          <line x1="155" y1="82" x2="182" y2="82" stroke="#333" strokeWidth="2"/>
          <line x1="155" y1="89" x2="180" y2="96" stroke="#333" strokeWidth="2"/>
          
          <ellipse cx="62" cy="88" rx="10" ry="6" fill="#FFB5B5" opacity="0.5"/>
          <ellipse cx="138" cy="88" rx="10" ry="6" fill="#FFB5B5" opacity="0.5"/>
        </svg>
      );
    };

    // ============== SPEECH BUBBLE ==============
    const SpeechBubble = ({ text, instant = false }) => {
      const [displayText, setDisplayText] = useState(instant ? text : '');
      
      useEffect(() => {
        if (instant) {
          setDisplayText(text);
          return;
        }
        setDisplayText('');
        let i = 0;
        const interval = setInterval(() => {
          if (i < text.length) {
            setDisplayText(text.slice(0, i + 1));
            i++;
          } else {
            clearInterval(interval);
          }
        }, 25);
        return () => clearInterval(interval);
      }, [text, instant]);
      
      return (
        <div style={{
          background: 'white',
          borderRadius: '24px',
          padding: '18px 24px',
          boxShadow: '0 4px 20px rgba(0,0,0,0.1)',
          border: '3px solid #FFE4D6',
          maxWidth: '320px',
          position: 'relative',
          animation: 'slideUp 0.3s ease-out'
        }}>
          <p style={{
            fontSize: '20px',
            color: '#5D4E4E',
            margin: 0,
            lineHeight: 1.5
          }}>
            {displayText}
            {!instant && displayText.length < text.length && (
              <span style={{ opacity: 0.5, animation: 'blink 0.8s infinite' }}>|</span>
            )}
          </p>
          <div style={{
            position: 'absolute',
            bottom: '-12px',
            left: '50%',
            transform: 'translateX(-50%)',
            width: 0,
            height: 0,
            borderLeft: '12px solid transparent',
            borderRight: '12px solid transparent',
            borderTop: '12px solid white'
          }}/>
        </div>
      );
    };

    // ============== TEXT TO SPEECH WITH ELEVENLABS ==============
    const useTextToSpeech = () => {
      const [isSpeaking, setIsSpeaking] = useState(false);
      const audioRef = useRef(null);
      const { settings } = useSettings();
      
      const speakWithElevenLabs = useCallback(async (text) => {
        if (!settings.elevenlabsKey) {
          return false;
        }
        
        try {
          setIsSpeaking(true);
          
          const response = await fetch(
            `https://api.elevenlabs.io/v1/text-to-speech/${settings.elevenlabsVoiceId || 'jBpfuIE2acCO8z3wKNLl'}`,
            {
              method: 'POST',
              headers: {
                'Accept': 'audio/mpeg',
                'Content-Type': 'application/json',
                'xi-api-key': settings.elevenlabsKey
              },
              body: JSON.stringify({
                text: text,
                model_id: 'eleven_turbo_v2_5',
                voice_settings: {
                  stability: 0.5,
                  similarity_boost: 0.75
                }
              })
            }
          );
          
          if (!response.ok) {
            throw new Error('ElevenLabs API error');
          }
          
          const audioBlob = await response.blob();
          const audioUrl = URL.createObjectURL(audioBlob);
          
          if (audioRef.current) {
            audioRef.current.pause();
          }
          
          const audio = new Audio(audioUrl);
          audioRef.current = audio;
          
          audio.onended = () => {
            setIsSpeaking(false);
            URL.revokeObjectURL(audioUrl);
          };
          
          audio.onerror = () => {
            setIsSpeaking(false);
            URL.revokeObjectURL(audioUrl);
          };
          
          await audio.play();
          return true;
          
        } catch (error) {
          console.error('ElevenLabs error:', error);
          setIsSpeaking(false);
          return false;
        }
      }, [settings]);
      
      const speakWithBrowser = useCallback((text) => {
        if ('speechSynthesis' in window) {
          window.speechSynthesis.cancel();
          const cleanText = text.replace(/[\u{1F300}-\u{1F9FF}]/gu, '');
          const utterance = new SpeechSynthesisUtterance(cleanText);
          utterance.rate = 0.85;
          utterance.pitch = 1.2;
          
          // Try to find a better voice
          const voices = window.speechSynthesis.getVoices();
          const preferredVoice = voices.find(v => 
            v.name.includes('Samantha') || 
            v.name.includes('Karen') ||
            v.name.includes('Victoria') ||
            v.name.includes('Google UK English Female')
          );
          if (preferredVoice) {
            utterance.voice = preferredVoice;
          }
          
          utterance.onstart = () => setIsSpeaking(true);
          utterance.onend = () => setIsSpeaking(false);
          utterance.onerror = () => setIsSpeaking(false);
          window.speechSynthesis.speak(utterance);
        }
      }, []);
      
      const speak = useCallback(async (text) => {
        const cleanText = text.replace(/[\u{1F300}-\u{1F9FF}]/gu, '');
        
        if (settings.useElevenlabs && settings.elevenlabsKey) {
          const success = await speakWithElevenLabs(cleanText);
          if (!success) {
            speakWithBrowser(cleanText);
          }
        } else {
          speakWithBrowser(cleanText);
        }
      }, [settings, speakWithElevenLabs, speakWithBrowser]);
      
      const stop = useCallback(() => {
        if (audioRef.current) {
          audioRef.current.pause();
          audioRef.current = null;
        }
        if ('speechSynthesis' in window) {
          window.speechSynthesis.cancel();
        }
        setIsSpeaking(false);
      }, []);
      
      return { speak, stop, isSpeaking };
    };

    // ============== LOCAL STORAGE ==============
    const useLocalStorage = (key, initialValue) => {
      const [value, setValue] = useState(() => {
        try {
          const item = localStorage.getItem(key);
          return item ? JSON.parse(item) : initialValue;
        } catch {
          return initialValue;
        }
      });
      
      const setStoredValue = (newValue) => {
        setValue(newValue);
        try {
          localStorage.setItem(key, JSON.stringify(newValue));
        } catch (e) {
          console.error('Failed to save to localStorage:', e);
        }
      };
      
      return [value, setStoredValue];
    };

    // ============== DEMO LESSONS ==============
    const generateDemoLesson = (problemText) => {
      const text = problemText.toLowerCase();
      
      // Clean up OCR artifacts - normalize math symbols
      const cleanText = problemText
        .replace(/\s+/g, ' ')           // normalize spaces
        .replace(/√ó/g, '*')             // multiplication sign
        .replace(/√∑/g, '/')             // division sign
        .replace(/[‚Äî‚Äì]/g, '-')          // different dash types
        .trim();
      
      console.log('Original text:', problemText);
      console.log('Cleaned text:', cleanText);
      
      // More flexible addition pattern
      const addMatch = cleanText.match(/(\d+)\s*[\+\Ôºã\*]\s*(\d+)/);
      if (addMatch) {
        const a = parseInt(addMatch[1]);
        const b = parseInt(addMatch[2]);
        const sum = a + b;
        console.log('Detected addition:', a, '+', b);
        return {
          subject: 'Math',
          originalText: problemText,
          steps: [
            { text: `Let's solve ${a} plus ${b} together!`, emoji: 'üßÆ', type: 'intro' },
            { text: `First, let's count ${a} apples!`, emoji: 'üçé'.repeat(Math.min(a, 10)), type: 'visual' },
            { text: `Great! Now let's add ${b} more apples!`, emoji: 'üçè'.repeat(Math.min(b, 10)), type: 'visual' },
            { text: `Put them all together and count!`, emoji: 'üëÜ', type: 'action' },
            { text: `One, two, three... keep counting!`, emoji: 'üî¢', type: 'action' },
            { text: `We have ${sum} apples in total!`, emoji: 'üçé'.repeat(Math.min(sum, 10)), type: 'visual' },
            { text: `${a} plus ${b} equals ${sum}!`, emoji: '‚úÖ', type: 'answer' },
            { text: `Amazing job! You're a math superstar!`, emoji: '‚≠ê', type: 'celebrate' }
          ]
        };
      }
      
      // More flexible subtraction pattern
      const subMatch = cleanText.match(/(\d+)\s*[\-\‚àí\‚Äì]\s*(\d+)/);
      if (subMatch) {
        const a = parseInt(subMatch[1]);
        const b = parseInt(subMatch[2]);
        const diff = Math.max(a - b, 0);
        console.log('Detected subtraction:', a, '-', b);
        return {
          subject: 'Math',
          originalText: problemText,
          steps: [
            { text: `Let's solve ${a} minus ${b} together!`, emoji: 'üßÆ', type: 'intro' },
            { text: `Start with ${a} cookies!`, emoji: 'üç™'.repeat(Math.min(a, 10)), type: 'visual' },
            { text: `Now we take away ${b} cookies...`, emoji: 'üëã', type: 'action' },
            { text: `Bye bye cookies!`, emoji: 'üç™'.repeat(Math.min(b, 10)) + '‚û°Ô∏è', type: 'visual' },
            { text: `How many cookies are left?`, emoji: 'ü§î', type: 'think' },
            { text: `Count what's left: ${diff} cookies!`, emoji: 'üç™'.repeat(Math.min(diff, 10)), type: 'visual' },
            { text: `${a} minus ${b} equals ${diff}!`, emoji: '‚úÖ', type: 'answer' },
            { text: `You did it! Super work!`, emoji: '‚≠ê', type: 'celebrate' }
          ]
        };
      }
      
      // Try to find any two numbers
      const numbers = cleanText.match(/\d+/g);
      if (numbers && numbers.length >= 2) {
        const a = parseInt(numbers[0]);
        const b = parseInt(numbers[1]);
        const sum = a + b;
        console.log('Found two numbers:', a, b, '- assuming addition');
        return {
          subject: 'Math',
          originalText: problemText,
          steps: [
            { text: `I see ${a} and ${b}! Let's add them!`, emoji: 'üßÆ', type: 'intro' },
            { text: `First, count ${a}!`, emoji: 'üçé'.repeat(Math.min(a, 10)), type: 'visual' },
            { text: `Now add ${b} more!`, emoji: 'üçè'.repeat(Math.min(b, 10)), type: 'visual' },
            { text: `Put them all together!`, emoji: 'üëÜ', type: 'action' },
            { text: `Count them all up!`, emoji: 'üî¢', type: 'action' },
            { text: `${a} plus ${b} equals ${sum}!`, emoji: '‚úÖ', type: 'answer' },
            { text: `Great job!`, emoji: '‚≠ê', type: 'celebrate' }
          ]
        };
      }
      
      // Single number found
      if (numbers && numbers.length === 1) {
        return {
          subject: 'Math',
          originalText: problemText,
          steps: [
            { text: `I see some numbers! Let's figure this out!`, emoji: 'üî¢', type: 'intro' },
            { text: `I found: ${numbers[0]}`, emoji: 'üëÄ', type: 'visual' },
            { text: `Let's think about what to do with this number.`, emoji: 'ü§î', type: 'think' },
            { text: `Try counting on your fingers!`, emoji: 'üñêÔ∏è', type: 'action' },
            { text: `You're doing great! Keep thinking!`, emoji: 'üí™', type: 'encourage' },
            { text: `Wonderful work trying this problem!`, emoji: '‚≠ê', type: 'celebrate' }
          ]
        };
      }
      
      if (text.length > 0 && text.length < 50) {
        return {
          subject: 'Reading',
          originalText: problemText,
          steps: [
            { text: `Let's read together!`, emoji: 'üìö', type: 'intro' },
            { text: `I see: "${problemText.trim()}"`, emoji: 'üëÄ', type: 'visual' },
            { text: `Let's sound it out slowly...`, emoji: 'üó£Ô∏è', type: 'action' },
            { text: `Listen carefully to each sound!`, emoji: 'üëÇ', type: 'action' },
            { text: `Now say it with me!`, emoji: 'üé§', type: 'action' },
            { text: `Great job sounding it out!`, emoji: 'üëè', type: 'celebrate' },
            { text: `You're becoming a great reader!`, emoji: '‚≠ê', type: 'celebrate' }
          ]
        };
      }
      
      return {
        subject: 'Learning',
        originalText: problemText,
        steps: [
          { text: `Let's look at this together!`, emoji: 'üìù', type: 'intro' },
          { text: `Hmm, let me see what we have here...`, emoji: 'üîç', type: 'visual' },
          { text: `Let's break it into small parts!`, emoji: '‚úÇÔ∏è', type: 'action' },
          { text: `Think about what you already know!`, emoji: 'ü§î', type: 'think' },
          { text: `You're doing great! Keep trying!`, emoji: 'üí™', type: 'encourage' },
          { text: `Excellent effort! I'm proud of you!`, emoji: '‚≠ê', type: 'celebrate' }
        ]
      };
    };

    // ============== CHATGPT AI LESSON GENERATION ==============
    const generateAiLesson = async (problemText, settings) => {
      if (settings.useDemoMode || !settings.openaiKey) {
        console.log('Using demo mode');
        return generateDemoLesson(problemText);
      }
      
      console.log('Calling ChatGPT API...');
      
      try {
        const response = await fetch('https://api.openai.com/v1/chat/completions', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${settings.openaiKey}`
          },
          body: JSON.stringify({
            model: 'gpt-4o-mini',
            messages: [{
              role: 'system',
              content: `You are Whiskers, a friendly cat teacher helping kindergarteners (age 5-6) with homework. 
You must respond with ONLY valid JSON, no markdown or code blocks.
Be warm, encouraging, patient, and use simple words a 5-year-old understands.`
            }, {
              role: 'user',
              content: `The student's homework says: "${problemText}"

Create a fun lesson. Respond with ONLY this JSON format:
{"subject":"Math or Reading","steps":[{"text":"short sentence under 12 words","emoji":"emojis","type":"intro or visual or action or think or answer or celebrate"}]}

Rules:
- 6-8 simple steps
- Use counting objects for math (apples, cookies, stars)
- Be very encouraging
- End with celebration`
            }],
            temperature: 0.7,
            max_tokens: 800
          })
        });
        
        if (!response.ok) {
          const errorText = await response.text();
          console.error('OpenAI API Error:', response.status, errorText);
          throw new Error(`API error: ${response.status}`);
        }
        
        const data = await response.json();
        console.log('ChatGPT response:', data);
        
        let content = data.choices[0].message.content;
        // Clean up potential markdown formatting
        content = content.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
        
        const lesson = JSON.parse(content);
        lesson.originalText = problemText;
        return lesson;
        
      } catch (error) {
        console.error('AI lesson error:', error);
        return generateDemoLesson(problemText);
      }
    };

    // ============== HOME SCREEN ==============
    const HomeScreen = ({ profile, stars, streak, onScan, onProfile }) => {
      const { settings } = useSettings();
      const t = getTranslation(settings.language);
      const [dialogue, setDialogue] = useState(t.greeting);
      const [catMood, setCatMood] = useState('happy');
      const { speak, isSpeaking } = useTextToSpeech();
      
      useEffect(() => {
        const greeting = profile.name 
          ? t.greetingWithName(profile.name)
          : t.greetings[Math.floor(Math.random() * t.greetings.length)];
        setDialogue(greeting);
        setTimeout(() => speak(greeting), 500);
      }, [settings.language]);
      
      const getModeLabel = () => {
        if (settings.useDemoMode) return 'üìã Demo';
        if (settings.openaiKey) return 'ü§ñ ChatGPT';
        return 'üìã Demo';
      };
      
      const getVoiceLabel = () => {
        if (settings.useElevenlabs && settings.elevenlabsKey) return 'üéôÔ∏è ElevenLabs';
        return 'üîä Browser';
      };
      
      return (
        <div style={{
          width: '100%',
          height: '100%',
          background: 'linear-gradient(180deg, #FFF8F0 0%, #FFF5E8 50%, #FFF8F0 100%)',
          display: 'flex',
          flexDirection: 'column',
          overflow: 'auto'
        }}>
          {/* Header */}
          <div style={{
            display: 'flex',
            justifyContent: 'space-between',
            alignItems: 'center',
            padding: '16px 24px'
          }}>
            <div style={{ display: 'flex', gap: '12px' }}>
              <div style={{
                background: 'rgba(255,213,79,0.2)',
                borderRadius: '16px',
                padding: '10px 16px',
                display: 'flex',
                alignItems: 'center',
                gap: '6px'
              }}>
                <span style={{ fontSize: '22px', animation: 'sparkle 2s infinite' }}>‚≠ê</span>
                <span style={{ fontSize: '20px', fontWeight: 'bold', color: '#FFB300' }}>{stars}</span>
              </div>
              <div style={{
                background: 'rgba(255,139,94,0.2)',
                borderRadius: '16px',
                padding: '10px 16px',
                display: 'flex',
                alignItems: 'center',
                gap: '6px'
              }}>
                <span style={{ fontSize: '22px' }}>üî•</span>
                <span style={{ fontSize: '20px', fontWeight: 'bold', color: '#FF8B5E' }}>{streak}</span>
              </div>
            </div>
            
            {/* Mode indicators */}
            <div style={{ display: 'flex', gap: '8px' }}>
              <div style={{
                background: settings.useDemoMode ? 'rgba(255,193,7,0.2)' : 'rgba(76,175,80,0.2)',
                borderRadius: '10px',
                padding: '4px 10px',
                fontSize: '11px',
                color: settings.useDemoMode ? '#F57C00' : '#388E3C'
              }}>
                {getModeLabel()}
              </div>
              <div style={{
                background: settings.useElevenlabs ? 'rgba(156,39,176,0.2)' : 'rgba(158,158,158,0.2)',
                borderRadius: '10px',
                padding: '4px 10px',
                fontSize: '11px',
                color: settings.useElevenlabs ? '#7B1FA2' : '#616161'
              }}>
                {getVoiceLabel()}
              </div>
            </div>
            
            <button
              onClick={onProfile}
              style={{
                background: 'white',
                border: '2px solid #FFE4D6',
                borderRadius: '50%',
                width: '48px',
                height: '48px',
                fontSize: '22px',
                cursor: 'pointer'
              }}
            >
              ‚öôÔ∏è
            </button>
          </div>
          
          {/* Main content */}
          <div style={{
            flex: 1,
            display: 'flex',
            flexDirection: 'column',
            alignItems: 'center',
            justifyContent: 'center',
            padding: '20px',
            gap: '16px'
          }}>
            <SpeechBubble text={dialogue} />
            
            <WhiskersCat mood={catMood} size={200} isTalking={isSpeaking} />
            
            {profile.name && (
              <div style={{
                background: 'rgba(255,139,94,0.1)',
                borderRadius: '20px',
                padding: '10px 20px',
                display: 'flex',
                alignItems: 'center',
                gap: '8px'
              }}>
                <span style={{ fontSize: '24px' }}>üê±</span>
                <span style={{ fontSize: '20px', color: '#FF8B5E', fontWeight: '600' }}>
                  {profile.name}
                </span>
              </div>
            )}
            
            {/* Scan button */}
            <button
              onClick={() => {
                setCatMood('excited');
                setDialogue(t.celebration.letMeSee);
                speak(t.celebration.letMeSee);
                setTimeout(onScan, 1500);
              }}
              style={{
                background: 'linear-gradient(135deg, #FF8B5E 0%, #FF7043 100%)',
                border: 'none',
                borderRadius: '28px',
                padding: '22px 44px',
                marginTop: '16px',
                cursor: 'pointer',
                boxShadow: '0 8px 32px rgba(255,139,94,0.4)',
                display: 'flex',
                alignItems: 'center',
                gap: '14px',
                animation: 'pulse 2s infinite'
              }}
            >
              <span style={{ fontSize: '38px' }}>üì∏</span>
              <div style={{ textAlign: 'left' }}>
                <div style={{ fontSize: '22px', color: 'white', fontWeight: 'bold' }}>
                  {t.scanButton}
                </div>
                <div style={{ fontSize: '13px', color: 'rgba(255,255,255,0.85)' }}>
                  {t.scanSubtext}
                </div>
              </div>
            </button>
          </div>
        </div>
      );
    };

    // ============== CAMERA SCREEN ==============
    const CameraScreen = ({ onCapture, onBack }) => {
      const videoRef = useRef(null);
      const canvasRef = useRef(null);
      const [hasCamera, setHasCamera] = useState(true);
      const [stream, setStream] = useState(null);
      const [cameraReady, setCameraReady] = useState(false);
      const [error, setError] = useState(null);
      const { settings } = useSettings();
      const t = getTranslation(settings.language);
      
      useEffect(() => {
        const startCamera = async () => {
          try {
            const mediaStream = await navigator.mediaDevices.getUserMedia({
              video: { 
                facingMode: 'environment', 
                width: { ideal: 1920 }, 
                height: { ideal: 1080 } 
              }
            });
            if (videoRef.current) {
              videoRef.current.srcObject = mediaStream;
              setStream(mediaStream);
              videoRef.current.onloadedmetadata = () => {
                setCameraReady(true);
              };
            }
          } catch (err) {
            console.error('Camera error:', err);
            setError(err.message);
            setHasCamera(false);
          }
        };
        
        startCamera();
        
        return () => {
          if (stream) {
            stream.getTracks().forEach(track => track.stop());
          }
        };
      }, []);
      
      const capturePhoto = () => {
        if (videoRef.current && canvasRef.current) {
          const video = videoRef.current;
          const canvas = canvasRef.current;
          canvas.width = video.videoWidth || 1280;
          canvas.height = video.videoHeight || 720;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(video, 0, 0);
          const imageData = canvas.toDataURL('image/jpeg', 0.9);
          
          if (stream) {
            stream.getTracks().forEach(track => track.stop());
          }
          
          onCapture(imageData);
        }
      };
      
      const handleFileUpload = (e) => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = (event) => {
            onCapture(event.target.result);
          };
          reader.readAsDataURL(file);
        }
      };
      
      return (
        <div style={{
          width: '100%',
          height: '100%',
          background: '#000',
          display: 'flex',
          flexDirection: 'column',
          position: 'relative'
        }}>
          <div style={{
            padding: '16px',
            display: 'flex',
            justifyContent: 'space-between',
            alignItems: 'center',
            background: 'rgba(0,0,0,0.5)',
            position: 'absolute',
            top: 0,
            left: 0,
            right: 0,
            zIndex: 10
          }}>
            <button
              onClick={onBack}
              style={{
                background: 'rgba(255,255,255,0.2)',
                border: 'none',
                borderRadius: '50%',
                width: '44px',
                height: '44px',
                fontSize: '24px',
                color: 'white',
                cursor: 'pointer'
              }}
            >
              ‚Üê
            </button>
            <span style={{ color: 'white', fontSize: '18px', fontWeight: '500' }}>
              üì∏ {t.cameraTitle}
            </span>
            <div style={{ width: '44px' }}></div>
          </div>
          
          {hasCamera ? (
            <video
              ref={videoRef}
              autoPlay
              playsInline
              muted
              style={{
                width: '100%',
                height: '100%',
                objectFit: 'cover'
              }}
            />
          ) : (
            <div style={{
              flex: 1,
              display: 'flex',
              flexDirection: 'column',
              alignItems: 'center',
              justifyContent: 'center',
              color: 'white',
              padding: '20px',
              textAlign: 'center'
            }}>
              <span style={{ fontSize: '60px', marginBottom: '20px' }}>üì∑</span>
              <p style={{ fontSize: '18px', marginBottom: '10px' }}>
                {t.cameraNotAvailable}
              </p>
              <p style={{ fontSize: '14px', color: '#aaa', marginBottom: '20px' }}>
                {error || t.uploadInstead}
              </p>
            </div>
          )}
          
          <canvas ref={canvasRef} style={{ display: 'none' }} />
          
          <div style={{
            position: 'absolute',
            bottom: 0,
            left: 0,
            right: 0,
            padding: '30px',
            paddingBottom: 'calc(30px + env(safe-area-inset-bottom, 0px))',
            display: 'flex',
            justifyContent: 'center',
            alignItems: 'center',
            gap: '30px',
            background: 'linear-gradient(transparent, rgba(0,0,0,0.8))'
          }}>
            <label style={{
              background: 'rgba(255,255,255,0.2)',
              border: '2px solid white',
              borderRadius: '50%',
              width: '56px',
              height: '56px',
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              fontSize: '24px',
              cursor: 'pointer'
            }}>
              üìÅ
              <input
                type="file"
                accept="image/*"
                capture="environment"
                onChange={handleFileUpload}
                style={{ display: 'none' }}
              />
            </label>
            
            {hasCamera && (
              <button
                onClick={capturePhoto}
                disabled={!cameraReady}
                style={{
                  background: cameraReady ? 'white' : '#666',
                  border: '4px solid #FF8B5E',
                  borderRadius: '50%',
                  width: '80px',
                  height: '80px',
                  cursor: cameraReady ? 'pointer' : 'not-allowed',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  fontSize: '36px'
                }}
              >
                {cameraReady ? 'üì∑' : '‚è≥'}
              </button>
            )}
            
            <label style={{
              background: '#FF8B5E',
              border: 'none',
              borderRadius: '50%',
              width: '56px',
              height: '56px',
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              fontSize: '24px',
              cursor: 'pointer'
            }}>
              üñºÔ∏è
              <input
                type="file"
                accept="image/*"
                onChange={handleFileUpload}
                style={{ display: 'none' }}
              />
            </label>
          </div>
        </div>
      );
    };

    // ============== SCANNING SCREEN ==============
    const ScanningScreen = ({ image, onComplete, onBack }) => {
      const { settings } = useSettings();
      const t = getTranslation(settings.language);
      const [status, setStatus] = useState(t.scanning.looking);
      const [progress, setProgress] = useState(0);
      const [detectedText, setDetectedText] = useState('');
      const [error, setError] = useState(null);
      const [showManualInput, setShowManualInput] = useState(false);
      const [manualText, setManualText] = useState('');
      const [usingVision, setUsingVision] = useState(false);
      const { speak, isSpeaking } = useTextToSpeech();
      
      useEffect(() => {
        speak(t.scanning.looking);
        runOCR();
      }, []);
      
      // ChatGPT Vision OCR - much more accurate
      const runChatGPTVision = async () => {
        if (!settings.openaiKey) {
          console.log('No OpenAI key, skipping Vision OCR');
          return null;
        }
        
        try {
          setUsingVision(true);
          console.log('Using ChatGPT Vision for OCR...');
          setStatus('ü§ñ AI is reading your homework...');
          
          const response = await fetch('https://api.openai.com/v1/chat/completions', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${settings.openaiKey}`
            },
            body: JSON.stringify({
              model: 'gpt-4o-mini',
              messages: [{
                role: 'user',
                content: [
                  {
                    type: 'text',
                    text: 'Look at this homework image. Extract ONLY the math problem or text shown. Reply with just the problem, nothing else. For example: "8 + 5 = ?" or "cat". Do not add quotes or explain, just give the exact text/problem you see.'
                  },
                  {
                    type: 'image_url',
                    image_url: {
                      url: image,
                      detail: 'low'
                    }
                  }
                ]
              }],
              max_tokens: 100
            })
          });
          
          if (!response.ok) {
            const errorText = await response.text();
            console.error('ChatGPT Vision error:', response.status, errorText);
            return null;
          }
          
          const data = await response.json();
          const text = data.choices[0].message.content.trim().replace(/^["']|["']$/g, '');
          console.log('ChatGPT Vision result:', text);
          return text;
          
        } catch (err) {
          console.error('ChatGPT Vision error:', err);
          return null;
        }
      };
      
      const runOCR = async () => {
        try {
          setStatus(t.scanning.starting);
          setProgress(10);
          
          // First try ChatGPT Vision if API key is available
          if (settings.openaiKey) {
            setProgress(20);
            const visionText = await runChatGPTVision();
            
            if (visionText && visionText.length >= 1) {
              setDetectedText(visionText);
              setProgress(85);
              setStatus(t.scanning.found);
              
              const lesson = await generateAiLesson(visionText, settings);
              
              setProgress(100);
              setStatus(t.scanning.gotIt);
              speak(t.scanning.gotIt);
              
              setTimeout(() => {
                onComplete({
                  originalText: visionText,
                  lesson: lesson
                });
              }, 1500);
              return;
            }
          }
          
          // Fallback to Tesseract OCR
          setUsingVision(false);
          if (typeof Tesseract === 'undefined') {
            throw new Error('OCR library not loaded');
          }
          
          setStatus(t.scanning.reading);
          setProgress(30);
          
          console.log('Attempting Tesseract OCR...');
          let result = await Tesseract.recognize(
            image,
            'eng',
            {
              logger: m => {
                if (m.status === 'recognizing text') {
                  setProgress(30 + Math.round(m.progress * 40));
                }
              }
            }
          );
          
          let text = result.data.text.trim();
          console.log('OCR Result:', JSON.stringify(text), 'Confidence:', result.data.confidence);
          
          // Check words array as fallback
          if ((!text || text.length < 2) && result.data.words && result.data.words.length > 0) {
            text = result.data.words.map(w => w.text).join(' ');
          }
          
          setDetectedText(text);
          setProgress(75);
          
          // If OCR result is poor, show manual input
          if (!text || text.length < 2) {
            setShowManualInput(true);
            setStatus("I'm having trouble reading this. Can you type it?");
            return;
          }
          
          setStatus(t.scanning.found);
          setProgress(85);
          
          const lesson = await generateAiLesson(text, settings);
          
          setProgress(100);
          setStatus(t.scanning.gotIt);
          speak(t.scanning.gotIt);
          
          setTimeout(() => {
            onComplete({
              originalText: text,
              lesson: lesson
            });
          }, 1500);
          
        } catch (err) {
          console.error('OCR Error:', err);
          setError(err.message);
          setShowManualInput(true);
          setStatus("Oops! Can you type what you see?");
        }
      };
      
      const handleManualSubmit = async () => {
        if (!manualText.trim()) return;
        
        setStatus(t.scanning.found);
        setProgress(85);
        
        const lesson = await generateAiLesson(manualText.trim(), settings);
        
        setProgress(100);
        setStatus(t.scanning.gotIt);
        speak(t.scanning.gotIt);
        
        setTimeout(() => {
          onComplete({
            originalText: manualText.trim(),
            lesson: lesson
          });
        }, 1000);
      };
      
      return (
        <div style={{
          width: '100%',
          height: '100%',
          background: 'linear-gradient(180deg, #FFF8F0 0%, #FFF5E8 100%)',
          display: 'flex',
          flexDirection: 'column',
          position: 'relative'
        }}>
          {/* Scrollable content */}
          <div style={{
            flex: 1,
            overflow: 'auto',
            WebkitOverflowScrolling: 'touch',
            display: 'flex',
            flexDirection: 'column',
            alignItems: 'center',
            padding: '20px',
            paddingBottom: '80px'
          }}>
            <WhiskersCat mood="thinking" size={120} isTalking={isSpeaking} />
            
            <div style={{ marginTop: '16px', textAlign: 'center', width: '100%', maxWidth: '340px' }}>
              <p style={{ fontSize: '18px', color: '#5D4E4E', marginBottom: '14px' }}>
                {status}
              </p>
              
              {!showManualInput && (
                <div style={{
                  width: '100%',
                  height: '12px',
                  background: '#FFE4D6',
                  borderRadius: '6px',
                  overflow: 'hidden',
                  marginBottom: '14px'
                }}>
                  <div style={{
                    width: `${progress}%`,
                    height: '100%',
                    background: 'linear-gradient(90deg, #FF8B5E, #FFB74D)',
                    borderRadius: '6px',
                    transition: 'width 0.5s ease-out'
                  }} />
                </div>
              )}
              
              {/* OCR Mode Indicator */}
              {usingVision && !showManualInput && (
                <div style={{
                  background: 'rgba(76,175,80,0.15)',
                  borderRadius: '8px',
                  padding: '6px 12px',
                  marginBottom: '12px',
                  fontSize: '12px',
                  color: '#388E3C'
                }}>
                  ü§ñ Using ChatGPT Vision
                </div>
              )}
              
              {detectedText && (
                <div style={{
                  background: 'white',
                  borderRadius: '12px',
                  padding: '12px 14px',
                  marginBottom: '14px',
                  border: '2px solid #E8F5E9'
                }}>
                  <p style={{ fontSize: '11px', color: '#888', marginBottom: '4px' }}>
                    üìù {t.scanning.iFound}
                  </p>
                  <p style={{ 
                    fontSize: '22px', 
                    color: '#333', 
                    fontFamily: 'monospace',
                    background: '#f5f5f5',
                    padding: '10px',
                    borderRadius: '8px',
                    wordBreak: 'break-word',
                    fontWeight: 'bold'
                  }}>
                    {detectedText}
                  </p>
                </div>
              )}
              
              {/* Manual Input */}
              {showManualInput && (
                <div style={{
                  background: 'white',
                  borderRadius: '16px',
                  padding: '16px',
                  marginBottom: '14px',
                  boxShadow: '0 4px 12px rgba(0,0,0,0.1)'
                }}>
                  <p style={{ fontSize: '14px', color: '#666', marginBottom: '10px' }}>
                    ‚úèÔ∏è Type what you see:
                  </p>
                  <input
                    type="text"
                    value={manualText}
                    onChange={(e) => setManualText(e.target.value)}
                    placeholder="e.g. 8 + 5 = ?"
                    style={{
                      width: '100%',
                      padding: '12px',
                      fontSize: '20px',
                      fontFamily: 'monospace',
                      border: '3px solid #FFE4D6',
                      borderRadius: '12px',
                      textAlign: 'center',
                      outline: 'none',
                      marginBottom: '10px',
                      boxSizing: 'border-box'
                    }}
                    autoFocus
                  />
                  <button
                    onClick={handleManualSubmit}
                    disabled={!manualText.trim()}
                    style={{
                      width: '100%',
                      padding: '12px',
                      background: manualText.trim() ? 'linear-gradient(135deg, #FF8B5E, #FF7043)' : '#ccc',
                      color: 'white',
                      border: 'none',
                      borderRadius: '12px',
                      fontSize: '16px',
                      fontWeight: 'bold',
                      cursor: manualText.trim() ? 'pointer' : 'not-allowed'
                    }}
                  >
                    ‚úì Let's Learn!
                  </button>
                </div>
              )}
              
              {/* Tip for better results */}
              {!settings.openaiKey && !showManualInput && (
                <div style={{
                  background: 'rgba(255,193,7,0.15)',
                  borderRadius: '8px',
                  padding: '8px 12px',
                  marginBottom: '12px',
                  fontSize: '11px',
                  color: '#F57C00'
                }}>
                  üí° Add ChatGPT key in Settings for better accuracy!
                </div>
              )}
            </div>
            
            {/* Image preview */}
            <div style={{
              width: '120px',
              height: '90px',
              borderRadius: '10px',
              overflow: 'hidden',
              border: '3px solid #FFE4D6',
              boxShadow: '0 4px 12px rgba(0,0,0,0.1)',
              flexShrink: 0
            }}>
              <img src={image} alt="Homework" style={{ width: '100%', height: '100%', objectFit: 'cover' }} />
            </div>
          </div>
          
          {/* Fixed bottom button */}
          <div style={{
            position: 'absolute',
            bottom: 0,
            left: 0,
            right: 0,
            padding: '12px 20px',
            paddingBottom: 'calc(12px + env(safe-area-inset-bottom, 0px))',
            background: 'linear-gradient(transparent, #FFF5E8 30%)',
            display: 'flex',
            justifyContent: 'center'
          }}>
            <button
              onClick={onBack}
              style={{
                background: 'white',
                border: '2px solid #FF8B5E',
                borderRadius: '14px',
                padding: '12px 28px',
                color: '#FF8B5E',
                fontSize: '16px',
                fontWeight: '500',
                cursor: 'pointer',
                boxShadow: '0 2px 8px rgba(0,0,0,0.1)'
              }}
            >
              ‚Üê {t.lesson.tryAgain}
            </button>
          </div>
        </div>
      );
    };

    // ============== LESSON SCREEN ==============
    const LessonScreen = ({ data, onComplete, onBack, onAddStars }) => {
      const [currentStep, setCurrentStep] = useState(0);
      const [showCelebration, setShowCelebration] = useState(false);
      const { speak, isSpeaking } = useTextToSpeech();
      const { settings } = useSettings();
      const t = getTranslation(settings.language);
      
      const steps = data.lesson.steps;
      const step = steps[currentStep];
      
      useEffect(() => {
        if (step) {
          speak(step.text);
        }
      }, [currentStep]);
      
      const nextStep = () => {
        if (currentStep < steps.length - 1) {
          setCurrentStep(currentStep + 1);
        } else {
          setShowCelebration(true);
          speak(t.celebration.amazing + " " + t.celebration.earned);
          onAddStars(3);
          setTimeout(onComplete, 4000);
        }
      };
      
      const prevStep = () => {
        if (currentStep > 0) setCurrentStep(currentStep - 1);
      };
      
      if (showCelebration) {
        return (
          <div style={{
            width: '100%',
            height: '100%',
            background: 'linear-gradient(180deg, #FFF8F0 0%, #FFFDE7 100%)',
            display: 'flex',
            flexDirection: 'column',
            alignItems: 'center',
            justifyContent: 'center'
          }}>
            <div style={{ fontSize: '70px', animation: 'bounce 0.5s infinite' }}>üéâ</div>
            <WhiskersCat mood="celebrating" size={180} isTalking={isSpeaking} />
            <h1 style={{ fontSize: '30px', color: '#FF8B5E', margin: '16px 0' }}>{t.celebration.amazing}</h1>
            <div style={{ display: 'flex', gap: '8px', marginBottom: '16px' }}>
              {[1, 2, 3].map(i => (
                <span key={i} style={{ fontSize: '44px', animation: `sparkle 0.5s ease-out ${i * 0.2}s` }}>‚≠ê</span>
              ))}
            </div>
            <p style={{ fontSize: '20px', color: '#5D4E4E' }}>{t.celebration.earned}</p>
          </div>
        );
      }
      
      return (
        <div style={{
          width: '100%',
          height: '100%',
          background: 'linear-gradient(180deg, #FFF8F0 0%, #FFF5E8 100%)',
          display: 'flex',
          flexDirection: 'column'
        }}>
          <div style={{
            padding: '14px 20px',
            display: 'flex',
            justifyContent: 'space-between',
            alignItems: 'center',
            borderBottom: '2px solid #FFE4D6'
          }}>
            <button onClick={onBack} style={{
              background: '#FFE4D6',
              border: 'none',
              borderRadius: '10px',
              padding: '8px 14px',
              fontSize: '15px',
              cursor: 'pointer',
              color: '#FF8B5E'
            }}>‚Üê {t.lesson.back}</button>
            
            <div style={{ display: 'flex', gap: '5px', flexWrap: 'wrap', justifyContent: 'center', maxWidth: '180px' }}>
              {steps.map((_, i) => (
                <div key={i} style={{
                  width: i === currentStep ? '18px' : '9px',
                  height: '9px',
                  borderRadius: '5px',
                  background: i <= currentStep ? '#FF8B5E' : '#FFE4D6',
                  transition: 'all 0.3s'
                }} />
              ))}
            </div>
            
            <div style={{
              background: '#FFE4D6',
              borderRadius: '10px',
              padding: '6px 12px',
              fontSize: '13px',
              color: '#FF8B5E'
            }}>{data.lesson.subject}</div>
          </div>
          
          <div style={{
            flex: 1,
            display: 'flex',
            flexDirection: 'column',
            alignItems: 'center',
            justifyContent: 'center',
            padding: '20px',
            gap: '14px',
            overflow: 'auto'
          }}>
            <SpeechBubble text={step.text} key={currentStep} />
            
            <WhiskersCat 
              mood={step.type === 'celebrate' ? 'celebrating' : step.type === 'think' ? 'thinking' : 'happy'} 
              size={150} 
              isTalking={isSpeaking} 
            />
            
            {step.emoji && (
              <div style={{
                fontSize: '40px',
                padding: '14px 22px',
                background: 'rgba(255,255,255,0.9)',
                borderRadius: '18px',
                boxShadow: '0 4px 12px rgba(0,0,0,0.05)',
                animation: 'float 2s ease-in-out infinite',
                letterSpacing: '3px',
                textAlign: 'center',
                maxWidth: '280px'
              }}>
                {step.emoji}
              </div>
            )}
          </div>
          
          <div style={{
            padding: '16px 20px',
            paddingBottom: 'calc(16px + env(safe-area-inset-bottom, 0px))',
            display: 'flex',
            gap: '14px',
            borderTop: '2px solid #FFE4D6',
            background: '#FFF8F0'
          }}>
            <button onClick={prevStep} disabled={currentStep === 0} style={{
              flex: 1,
              background: currentStep === 0 ? '#EEE' : '#FFE4D6',
              border: 'none',
              borderRadius: '18px',
              padding: '16px',
              fontSize: '17px',
              cursor: currentStep === 0 ? 'not-allowed' : 'pointer',
              color: currentStep === 0 ? '#AAA' : '#FF8B5E'
            }}>‚Üê {t.lesson.back}</button>
            
            <button onClick={nextStep} style={{
              flex: 2,
              background: 'linear-gradient(135deg, #FF8B5E, #FF7043)',
              border: 'none',
              borderRadius: '18px',
              padding: '16px',
              fontSize: '18px',
              cursor: 'pointer',
              color: 'white',
              fontWeight: 'bold',
              boxShadow: '0 4px 16px rgba(255,139,94,0.4)'
            }}>
              {currentStep === steps.length - 1 ? `üéâ ${t.lesson.finish}` : `${t.lesson.next} ‚Üí`}
            </button>
          </div>
        </div>
      );
    };

    // ============== ELEVENLABS VOICE OPTIONS ==============
    // These are verified voice IDs from ElevenLabs' default library
    const VOICE_OPTIONS = [
      { id: 'EXAVITQu4vr4xnSDxMaL', name: 'Sarah', desc: 'Soft, friendly female' },
      { id: '21m00Tcm4TlvDq8ikWAM', name: 'Rachel', desc: 'Calm, warm female' },
      { id: 'AZnzlk1XvdvUeBnXmlld', name: 'Domi', desc: 'Confident female' },
      { id: 'MF3mGyEYCl7XYWbV9V6O', name: 'Elli', desc: 'Cheerful young female' },
      { id: 'TxGEqnHWrfWFTfGW9XjX', name: 'Josh', desc: 'Deep, warm male' },
      { id: 'VR6AewLTigWG4xSOukaG', name: 'Arnold', desc: 'Strong, clear male' },
      { id: 'pNInz6obpgDQGcFmaJgB', name: 'Adam', desc: 'Deep, narrative male' },
      { id: 'yoZ06aMxZJJ28mfd3POQ', name: 'Sam', desc: 'Warm, friendly male' },
    ];

    // ============== LANGUAGE OPTIONS ==============
    const LANGUAGE_OPTIONS = [
      { id: 'en', name: 'English', testPhrase: "Hi! I'm Whiskers, your learning friend!" },
      { id: 'hi', name: '‡§π‡§ø‡§Ç‡§¶‡•Ä (Hindi)', testPhrase: "‡§®‡§Æ‡§∏‡•ç‡§§‡•á! ‡§Æ‡•à‡§Ç ‡§µ‡•ç‡§π‡§ø‡§∏‡•ç‡§ï‡§∞‡•ç‡§∏ ‡§π‡•Ç‡§Ç, ‡§§‡•Å‡§Æ‡•ç‡§π‡§æ‡§∞‡§æ ‡§∏‡•Ä‡§ñ‡§®‡•á ‡§µ‡§æ‡§≤‡§æ ‡§¶‡•ã‡§∏‡•ç‡§§!" },
      { id: 'ta', name: '‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç (Tamil)', testPhrase: "‡Æµ‡Æ£‡Æï‡Øç‡Æï‡ÆÆ‡Øç! ‡Æ®‡Ææ‡Æ©‡Øç ‡Æµ‡Æø‡Æ∏‡Øç‡Æï‡Æ∞‡Øç‡Æ∏‡Øç, ‡Æâ‡Æô‡Øç‡Æï‡Æ≥‡Øç ‡Æï‡Æ±‡Øç‡Æ±‡Æ≤‡Øç ‡Æ®‡Æ£‡Øç‡Æ™‡Æ©‡Øç!" },
      { id: 'ur', name: 'ÿßÿ±ÿØŸà (Urdu)', testPhrase: "ÿßŸÑÿ≥ŸÑÿßŸÖ ÿπŸÑ€å⁄©ŸÖ! ŸÖ€å⁄∫ Ÿàÿ≥⁄©ÿ±ÿ≤ €ÅŸà⁄∫ÿå ÿ¢Ÿæ ⁄©ÿß ÿ≥€å⁄©⁄æŸÜ€í ŸàÿßŸÑÿß ÿØŸàÿ≥ÿ™!" },
      { id: 'te', name: '‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å (Telugu)', testPhrase: "‡∞®‡∞Æ‡∞∏‡±ç‡∞ï‡∞æ‡∞∞‡∞Ç! ‡∞®‡±á‡∞®‡±Å ‡∞µ‡∞ø‡∞∏‡±ç‡∞ï‡∞∞‡±ç‡∞∏‡±ç, ‡∞Æ‡±Ä ‡∞®‡±á‡∞∞‡±ç‡∞ö‡±Å‡∞ï‡±Å‡∞®‡±á ‡∞∏‡±ç‡∞®‡±á‡∞π‡∞ø‡∞§‡±Å‡∞°‡∞ø‡∞®‡∞ø!" },
      { id: 'bn', name: '‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ (Bengali)', testPhrase: "‡¶®‡¶Æ‡¶∏‡ßç‡¶ï‡¶æ‡¶∞! ‡¶Ü‡¶Æ‡¶ø ‡¶π‡ßÅ‡¶á‡¶∏‡ßç‡¶ï‡¶æ‡¶∞‡ßç‡¶∏, ‡¶§‡ßã‡¶Æ‡¶æ‡¶∞ ‡¶∂‡ßá‡¶ñ‡¶æ‡¶∞ ‡¶¨‡¶®‡ßç‡¶ß‡ßÅ!" },
      { id: 'mr', name: '‡§Æ‡§∞‡§æ‡§†‡•Ä (Marathi)', testPhrase: "‡§®‡§Æ‡§∏‡•ç‡§ï‡§æ‡§∞! ‡§Æ‡•Ä ‡§µ‡•ç‡§π‡§ø‡§∏‡•ç‡§ï‡§∞‡•ç‡§∏ ‡§Ü‡§π‡•á, ‡§§‡•Å‡§Æ‡§ö‡§æ ‡§∂‡§ø‡§ï‡§£‡•ç‡§Ø‡§æ‡§ö‡§æ ‡§Æ‡§ø‡§§‡•ç‡§∞!" },
      { id: 'gu', name: '‡™ó‡´Å‡™ú‡™∞‡™æ‡™§‡´Ä (Gujarati)', testPhrase: "‡™®‡™Æ‡™∏‡´ç‡™§‡´á! ‡™π‡´Å‡™Ç ‡™µ‡´ç‡™π‡™ø‡™∏‡´ç‡™ï‡™∞‡´ç‡™∏ ‡™õ‡´Å‡™Ç, ‡™§‡™Æ‡™æ‡™∞‡´ã ‡™∂‡´Ä‡™ñ‡™µ‡™æ‡™®‡´ã ‡™Æ‡™ø‡™§‡´ç‡™∞!" },
      { id: 'kn', name: '‡≤ï‡≤®‡≥ç‡≤®‡≤° (Kannada)', testPhrase: "‡≤®‡≤Æ‡≤∏‡≥ç‡≤ï‡≤æ‡≤∞! ‡≤®‡≤æ‡≤®‡≥Å ‡≤µ‡≤ø‡≤∏‡≥ç‡≤ï‡≤∞‡≥ç‡≤∏‡≥ç, ‡≤®‡≤ø‡≤Æ‡≥ç‡≤Æ ‡≤ï‡≤≤‡≤ø‡≤ï‡≥Ü‡≤Ø ‡≤ó‡≥Ü‡≤≥‡≥Ü‡≤Ø!" },
      { id: 'ml', name: '‡¥Æ‡¥≤‡¥Ø‡¥æ‡¥≥‡¥Ç (Malayalam)', testPhrase: "‡¥®‡¥Æ‡¥∏‡µç‡¥ï‡¥æ‡¥∞‡¥Ç! ‡¥û‡¥æ‡µª ‡¥µ‡¥ø‡¥∏‡µç‡¥ï‡µá‡¥¥‡µç‡¥∏‡µç ‡¥Ü‡¥£‡µç, ‡¥®‡¥ø‡¥ô‡µç‡¥ô‡¥≥‡µÅ‡¥ü‡µÜ ‡¥™‡¥†‡¥® ‡¥∏‡µÅ‡¥π‡µÉ‡¥§‡µç‡¥§‡µç!" },
      { id: 'pa', name: '‡®™‡©∞‡®ú‡®æ‡®¨‡©Ä (Punjabi)', testPhrase: "‡®∏‡®§ ‡®∏‡©ç‡®∞‡©Ä ‡®Ö‡®ï‡®æ‡®≤! ‡®Æ‡©à‡®Ç ‡®µ‡®ø‡®∏‡®ï‡®∞‡®ú‡®º ‡®π‡®æ‡®Ç, ‡®§‡©Å‡®π‡®æ‡®°‡®æ ‡®∏‡®ø‡©±‡®ñ‡®£ ‡®µ‡®æ‡®≤‡®æ ‡®¶‡©ã‡®∏‡®§!" },
      { id: 'ar', name: 'ÿßŸÑÿπÿ±ÿ®Ÿäÿ© (Arabic)', testPhrase: "ŸÖÿ±ÿ≠ÿ®ÿßŸã! ÿ£ŸÜÿß ŸàŸäÿ≥ŸÉÿ±ÿ≤ÿå ÿµÿØŸäŸÇŸÉ ŸÅŸä ÿßŸÑÿ™ÿπŸÑŸÖ!" },
    ];

    // ============== TRANSLATIONS ==============
    const TRANSLATIONS = {
      en: {
        greeting: "Hi there, friend! Ready to learn something amazing today?",
        greetingWithName: (name) => `Hi ${name}! Ready to learn today?`,
        greetings: [
          "Hi there, friend! Ready to learn something amazing today?",
          "Yay, you're here! Let's have fun learning!",
          "Hello, superstar! What should we explore?",
          "I'm so happy to see you!"
        ],
        scanButton: "Scan Homework",
        scanSubtext: "Take a photo of your worksheet",
        cameraTitle: "Point at your homework",
        cameraNotAvailable: "Camera not available",
        uploadInstead: "Please upload a photo instead",
        scanning: {
          looking: "Whiskers is looking at your homework...",
          starting: "Starting up my reading glasses...",
          reading: "Reading the words and numbers...",
          found: "Found it! Now thinking about how to help...",
          gotIt: "Got it! Let me teach you!",
          couldntRead: "Hmm, I couldn't read that clearly. Let me try my best!",
          tryDifferent: "Oops! Let me try a different way...",
          iFound: "I found:"
        },
        lesson: {
          back: "Back",
          next: "Next",
          finish: "Finish!",
          tryAgain: "Try again"
        },
        celebration: {
          amazing: "Amazing Job!",
          earned: "You earned 3 stars!",
          letMeSee: "Ooh! Let me see your homework!"
        },
        settings: {
          title: "Settings",
          childName: "Child's Name",
          enterName: "Enter name",
          stars: "Stars",
          streak: "Streak",
          testVoice: "Test Voice",
          showApi: "Show API Settings",
          hideApi: "Hide API Settings",
          currentSetup: "Current Setup",
          ai: "AI",
          voice: "Voice",
          language: "Language",
          demoMode: "Demo mode",
          browserTts: "Browser TTS",
          chooseVoice: "Choose Voice:",
          chooseLanguage: "Choose Language:",
          saveSettings: "Save Settings",
          apiKeyHint: "Get from elevenlabs.io ‚Üí Profile ‚Üí API Key"
        }
      },
      hi: {
        greeting: "‡§®‡§Æ‡§∏‡•ç‡§§‡•á ‡§¶‡•ã‡§∏‡•ç‡§§! ‡§Ü‡§ú ‡§ï‡•Å‡§õ ‡§Æ‡§ú‡§º‡•á‡§¶‡§æ‡§∞ ‡§∏‡•Ä‡§ñ‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§§‡•à‡§Ø‡§æ‡§∞ ‡§π‡•ã?",
        greetingWithName: (name) => `‡§®‡§Æ‡§∏‡•ç‡§§‡•á ${name}! ‡§Ü‡§ú ‡§∏‡•Ä‡§ñ‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§§‡•à‡§Ø‡§æ‡§∞?`,
        greetings: [
          "‡§®‡§Æ‡§∏‡•ç‡§§‡•á ‡§¶‡•ã‡§∏‡•ç‡§§! ‡§Ü‡§ú ‡§ï‡•Å‡§õ ‡§Æ‡§ú‡§º‡•á‡§¶‡§æ‡§∞ ‡§∏‡•Ä‡§ñ‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§§‡•à‡§Ø‡§æ‡§∞ ‡§π‡•ã?",
          "‡§Ø‡§π‡§æ‡§Å ‡§Ü‡§ï‡§∞ ‡§¨‡§π‡•Å‡§§ ‡§Ö‡§ö‡•ç‡§õ‡§æ ‡§≤‡§ó‡§æ! ‡§ö‡§≤‡•ã ‡§Æ‡§ú‡§º‡•á ‡§∏‡•á ‡§∏‡•Ä‡§ñ‡§§‡•á ‡§π‡•à‡§Ç!",
          "‡§π‡•á‡§≤‡•ã ‡§∏‡•Å‡§™‡§∞‡§∏‡•ç‡§ü‡§æ‡§∞! ‡§Ü‡§ú ‡§ï‡•ç‡§Ø‡§æ ‡§∏‡•Ä‡§ñ‡•á‡§Ç?",
          "‡§§‡•Å‡§Æ‡•ç‡§π‡•á‡§Ç ‡§¶‡•á‡§ñ‡§ï‡§∞ ‡§¨‡§π‡•Å‡§§ ‡§ñ‡•Å‡§∂‡•Ä ‡§π‡•Å‡§à!"
        ],
        scanButton: "‡§π‡•ã‡§Æ‡§µ‡§∞‡•ç‡§ï ‡§∏‡•ç‡§ï‡•à‡§® ‡§ï‡§∞‡•ã",
        scanSubtext: "‡§Ö‡§™‡§®‡•Ä ‡§µ‡§∞‡•ç‡§ï‡§∂‡•Ä‡§ü ‡§ï‡•Ä ‡§´‡•ã‡§ü‡•ã ‡§≤‡•ã",
        cameraTitle: "‡§Ö‡§™‡§®‡§æ ‡§π‡•ã‡§Æ‡§µ‡§∞‡•ç‡§ï ‡§¶‡§ø‡§ñ‡§æ‡§ì",
        cameraNotAvailable: "‡§ï‡•à‡§Æ‡§∞‡§æ ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à",
        uploadInstead: "‡§ï‡•É‡§™‡§Ø‡§æ ‡§´‡•ã‡§ü‡•ã ‡§Ö‡§™‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç",
        scanning: {
          looking: "‡§µ‡•ç‡§π‡§ø‡§∏‡•ç‡§ï‡§∞‡•ç‡§∏ ‡§§‡•Å‡§Æ‡•ç‡§π‡§æ‡§∞‡§æ ‡§π‡•ã‡§Æ‡§µ‡§∞‡•ç‡§ï ‡§¶‡•á‡§ñ ‡§∞‡§π‡§æ ‡§π‡•à...",
          starting: "‡§Ö‡§™‡§®‡§æ ‡§ö‡§∂‡•ç‡§Æ‡§æ ‡§≤‡§ó‡§æ ‡§∞‡§π‡§æ ‡§π‡•Ç‡§Ç...",
          reading: "‡§∂‡§¨‡•ç‡§¶ ‡§î‡§∞ ‡§®‡§Ç‡§¨‡§∞ ‡§™‡§¢‡§º ‡§∞‡§π‡§æ ‡§π‡•Ç‡§Ç...",
          found: "‡§Æ‡§ø‡§≤ ‡§ó‡§Ø‡§æ! ‡§Ö‡§¨ ‡§∏‡•ã‡§ö ‡§∞‡§π‡§æ ‡§π‡•Ç‡§Ç ‡§ï‡•à‡§∏‡•á ‡§Æ‡§¶‡§¶ ‡§ï‡§∞‡•Ç‡§Ç...",
          gotIt: "‡§∏‡§Æ‡§ù ‡§ó‡§Ø‡§æ! ‡§ö‡§≤‡•ã ‡§∏‡§ø‡§ñ‡§æ‡§§‡§æ ‡§π‡•Ç‡§Ç!",
          couldntRead: "‡§π‡§Æ‡•ç‡§Æ, ‡§†‡•Ä‡§ï ‡§∏‡•á ‡§™‡§¢‡§º ‡§®‡§π‡•Ä‡§Ç ‡§™‡§æ‡§Ø‡§æ‡•§ ‡§ï‡•ã‡§∂‡§ø‡§∂ ‡§ï‡§∞‡§§‡§æ ‡§π‡•Ç‡§Ç!",
          tryDifferent: "‡§â‡§´‡§º! ‡§¶‡•Ç‡§∏‡§∞‡•á ‡§§‡§∞‡•Ä‡§ï‡•á ‡§∏‡•á ‡§ï‡•ã‡§∂‡§ø‡§∂ ‡§ï‡§∞‡§§‡§æ ‡§π‡•Ç‡§Ç...",
          iFound: "‡§Æ‡•Å‡§ù‡•á ‡§Æ‡§ø‡§≤‡§æ:"
        },
        lesson: {
          back: "‡§™‡•Ä‡§õ‡•á",
          next: "‡§Ü‡§ó‡•á",
          finish: "‡§ñ‡§§‡•ç‡§Æ!",
          tryAgain: "‡§´‡§ø‡§∞ ‡§∏‡•á"
        },
        celebration: {
          amazing: "‡§∂‡§æ‡§¨‡§æ‡§∂!",
          earned: "‡§§‡•Å‡§Æ‡§®‡•á 3 ‡§∏‡§ø‡§§‡§æ‡§∞‡•á ‡§ú‡•Ä‡§§‡•á!",
          letMeSee: "‡§µ‡§æ‡§π! ‡§Æ‡•Å‡§ù‡•á ‡§Ö‡§™‡§®‡§æ ‡§π‡•ã‡§Æ‡§µ‡§∞‡•ç‡§ï ‡§¶‡§ø‡§ñ‡§æ‡§ì!"
        },
        settings: {
          title: "‡§∏‡•á‡§ü‡§ø‡§Ç‡§ó‡•ç‡§∏",
          childName: "‡§¨‡§ö‡•ç‡§ö‡•á ‡§ï‡§æ ‡§®‡§æ‡§Æ",
          enterName: "‡§®‡§æ‡§Æ ‡§≤‡§ø‡§ñ‡•ã",
          stars: "‡§∏‡§ø‡§§‡§æ‡§∞‡•á",
          streak: "‡§∏‡•ç‡§ü‡•ç‡§∞‡•Ä‡§ï",
          testVoice: "‡§Ü‡§µ‡§æ‡§ú‡§º ‡§ü‡•á‡§∏‡•ç‡§ü ‡§ï‡§∞‡•ã",
          showApi: "API ‡§∏‡•á‡§ü‡§ø‡§Ç‡§ó‡•ç‡§∏ ‡§¶‡§ø‡§ñ‡§æ‡§ì",
          hideApi: "API ‡§∏‡•á‡§ü‡§ø‡§Ç‡§ó‡•ç‡§∏ ‡§õ‡•Å‡§™‡§æ‡§ì",
          currentSetup: "‡§Æ‡•å‡§ú‡•Ç‡§¶‡§æ ‡§∏‡•á‡§ü‡§Ö‡§™",
          ai: "AI",
          voice: "‡§Ü‡§µ‡§æ‡§ú‡§º",
          language: "‡§≠‡§æ‡§∑‡§æ",
          demoMode: "‡§°‡•á‡§Æ‡•ã ‡§Æ‡•ã‡§°",
          browserTts: "‡§¨‡•ç‡§∞‡§æ‡§â‡§ú‡§º‡§∞ TTS",
          chooseVoice: "‡§Ü‡§µ‡§æ‡§ú‡§º ‡§ö‡•Å‡§®‡•ã:",
          chooseLanguage: "‡§≠‡§æ‡§∑‡§æ ‡§ö‡•Å‡§®‡•ã:",
          saveSettings: "‡§∏‡•á‡§ü‡§ø‡§Ç‡§ó‡•ç‡§∏ ‡§∏‡•á‡§µ ‡§ï‡§∞‡•ã",
          apiKeyHint: "elevenlabs.io ‡§∏‡•á API Key ‡§≤‡•ã"
        }
      },
      ta: {
        greeting: "‡Æµ‡Æ£‡Æï‡Øç‡Æï‡ÆÆ‡Øç ‡Æ®‡Æ£‡Øç‡Æ™‡Ææ! ‡Æá‡Æ©‡Øç‡Æ±‡ØÅ ‡Æè‡Æ§‡Ææ‡Æµ‡Æ§‡ØÅ ‡ÆÖ‡Æ∞‡ØÅ‡ÆÆ‡Øà‡ÆØ‡Ææ‡Æ© ‡Æµ‡Æø‡Æ∑‡ÆØ‡ÆÆ‡Øç ‡Æï‡Æ±‡Øç‡Æï ‡Æ§‡ÆØ‡Ææ‡Æ∞‡Ææ?",
        greetingWithName: (name) => `‡Æµ‡Æ£‡Æï‡Øç‡Æï‡ÆÆ‡Øç ${name}! ‡Æá‡Æ©‡Øç‡Æ±‡ØÅ ‡Æï‡Æ±‡Øç‡Æï ‡Æ§‡ÆØ‡Ææ‡Æ∞‡Ææ?`,
        greetings: [
          "‡Æµ‡Æ£‡Æï‡Øç‡Æï‡ÆÆ‡Øç ‡Æ®‡Æ£‡Øç‡Æ™‡Ææ! ‡Æá‡Æ©‡Øç‡Æ±‡ØÅ ‡Æè‡Æ§‡Ææ‡Æµ‡Æ§‡ØÅ ‡ÆÖ‡Æ∞‡ØÅ‡ÆÆ‡Øà‡ÆØ‡Ææ‡Æ© ‡Æµ‡Æø‡Æ∑‡ÆØ‡ÆÆ‡Øç ‡Æï‡Æ±‡Øç‡Æï ‡Æ§‡ÆØ‡Ææ‡Æ∞‡Ææ?",
          "‡Æ®‡ØÄ ‡Æµ‡Æ®‡Øç‡Æ§‡ØÅ‡Æü‡Øç‡Æü‡Øá! ‡ÆÆ‡Æï‡Æø‡Æ¥‡Øç‡Æö‡Øç‡Æö‡Æø‡ÆØ‡Ææ ‡Æ™‡Æü‡Æø‡Æï‡Øç‡Æï‡Æ≤‡Ææ‡ÆÆ‡Øç!",
          "‡Æπ‡Æ≤‡Øã ‡Æö‡ØÇ‡Æ™‡Øç‡Æ™‡Æ∞‡Øç‡Æ∏‡Øç‡Æü‡Ææ‡Æ∞‡Øç! ‡Æé‡Æ©‡Øç‡Æ© ‡Æï‡Æ±‡Øç‡Æ™‡Øã‡ÆÆ‡Øç?",
          "‡Æâ‡Æ©‡Øç‡Æ©‡Øà‡Æ™‡Øç ‡Æ™‡Ææ‡Æ∞‡Øç‡Æ§‡Øç‡Æ§‡Æ§‡Æø‡Æ≤‡Øç ‡ÆÆ‡Æø‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç ‡ÆÆ‡Æï‡Æø‡Æ¥‡Øç‡Æö‡Øç‡Æö‡Æø!"
        ],
        scanButton: "‡Æµ‡ØÄ‡Æü‡Øç‡Æü‡ØÅ‡Æ™‡Øç‡Æ™‡Ææ‡Æü‡ÆÆ‡Øç ‡Æ∏‡Øç‡Æï‡Øá‡Æ©‡Øç",
        scanSubtext: "‡Æâ‡Æ©‡Øç ‡Æí‡Æ∞‡Øç‡Æï‡Øç‡Æ∑‡ØÄ‡Æü‡Øç‡Æü‡Øà ‡Æ™‡ØÅ‡Æï‡Øà‡Æ™‡Øç‡Æ™‡Æü‡ÆÆ‡Øç ‡Æé‡Æü‡ØÅ",
        cameraTitle: "‡Æµ‡ØÄ‡Æü‡Øç‡Æü‡ØÅ‡Æ™‡Øç‡Æ™‡Ææ‡Æü‡Æ§‡Øç‡Æ§‡Øà ‡Æï‡Ææ‡Æü‡Øç‡Æü‡ØÅ",
        cameraNotAvailable: "‡Æï‡Øá‡ÆÆ‡Æ∞‡Ææ ‡Æá‡Æ≤‡Øç‡Æ≤‡Øà",
        uploadInstead: "‡Æ™‡ØÅ‡Æï‡Øà‡Æ™‡Øç‡Æ™‡Æü‡ÆÆ‡Øç ‡ÆÖ‡Æ™‡Øç‡Æ≤‡Øã‡Æü‡Øç ‡Æö‡ØÜ‡ÆØ‡Øç‡ÆØ‡Æµ‡ØÅ‡ÆÆ‡Øç",
        scanning: {
          looking: "‡Æµ‡Æø‡Æ∏‡Øç‡Æï‡Æ∞‡Øç‡Æ∏‡Øç ‡Æâ‡Æ©‡Øç ‡Æµ‡ØÄ‡Æü‡Øç‡Æü‡ØÅ‡Æ™‡Øç‡Æ™‡Ææ‡Æü‡ÆÆ‡Øç ‡Æ™‡Ææ‡Æ∞‡Øç‡Æï‡Øç‡Æï‡Æø‡Æ±‡Ææ‡Æ∞‡Øç...",
          starting: "‡Æé‡Æ©‡Øç ‡Æï‡Æ£‡Øç‡Æ£‡Ææ‡Æü‡Æø ‡Æ™‡Øã‡Æü‡ØÅ‡Æï‡Æø‡Æ±‡Øá‡Æ©‡Øç...",
          reading: "‡Æµ‡Ææ‡Æ∞‡Øç‡Æ§‡Øç‡Æ§‡Øà‡Æï‡Æ≥‡Øç ‡Æé‡Æ£‡Øç‡Æï‡Æ≥‡Øç ‡Æ™‡Æü‡Æø‡Æï‡Øç‡Æï‡Æø‡Æ±‡Øá‡Æ©‡Øç...",
          found: "‡Æï‡Æø‡Æü‡Øà‡Æö‡Øç‡Æö‡ØÅ‡Æ§‡ØÅ! ‡Æé‡Æ™‡Øç‡Æ™‡Æü‡Æø ‡Æâ‡Æ§‡Æµ‡Æ≤‡Ææ‡ÆÆ‡Øç ‡ÆØ‡Øã‡Æö‡Æø‡Æï‡Øç‡Æï‡Æø‡Æ±‡Øá‡Æ©‡Øç...",
          gotIt: "‡Æ™‡ØÅ‡Æ∞‡Æø‡Æû‡Øç‡Æö‡ØÅ‡Æ§‡ØÅ! ‡Æï‡Æ±‡Øç‡Æ±‡ØÅ‡Æï‡Øç‡Æï‡Øä‡Æü‡ØÅ‡Æï‡Øç‡Æï‡Æø‡Æ±‡Øá‡Æ©‡Øç!",
          couldntRead: "‡Æö‡Æ∞‡Æø‡ÆØ‡Ææ ‡Æ™‡Æü‡Æø‡Æï‡Øç‡Æï ‡ÆÆ‡ØÅ‡Æü‡Æø‡ÆØ‡Æ≤. ‡ÆÆ‡ØÅ‡ÆØ‡Æ±‡Øç‡Æö‡Æø ‡Æö‡ØÜ‡ÆØ‡Øç‡Æï‡Æø‡Æ±‡Øá‡Æ©‡Øç!",
          tryDifferent: "‡ÆÖ‡Æü! ‡Æµ‡Øá‡Æ± ‡Æµ‡Æ¥‡Æø‡ÆØ‡Æø‡Æ≤‡Øç ‡ÆÆ‡ØÅ‡ÆØ‡Æ±‡Øç‡Æö‡Æø‡Æï‡Øç‡Æï‡Æø‡Æ±‡Øá‡Æ©‡Øç...",
          iFound: "‡Æé‡Æ©‡Æï‡Øç‡Æï‡ØÅ ‡Æï‡Æø‡Æü‡Øà‡Æö‡Øç‡Æö‡Æ§‡ØÅ:"
        },
        lesson: {
          back: "‡Æ™‡Æø‡Æ©‡Øç",
          next: "‡ÆÖ‡Æü‡ØÅ‡Æ§‡Øç‡Æ§‡ØÅ",
          finish: "‡ÆÆ‡ØÅ‡Æü‡Æø‡Æ®‡Øç‡Æ§‡Æ§‡ØÅ!",
          tryAgain: "‡ÆÆ‡ØÄ‡Æ£‡Øç‡Æü‡ØÅ‡ÆÆ‡Øç"
        },
        celebration: {
          amazing: "‡ÆÖ‡Æ∞‡ØÅ‡ÆÆ‡Øà!",
          earned: "‡Æ®‡ØÄ 3 ‡Æ®‡Æü‡Øç‡Æö‡Æ§‡Øç‡Æ§‡Æø‡Æ∞‡Æô‡Øç‡Æï‡Æ≥‡Øç ‡Æµ‡ØÜ‡Æ©‡Øç‡Æ±‡Ææ‡ÆØ‡Øç!",
          letMeSee: "‡Æµ‡Ææ! ‡Æâ‡Æ©‡Øç ‡Æµ‡ØÄ‡Æü‡Øç‡Æü‡ØÅ‡Æ™‡Øç‡Æ™‡Ææ‡Æü‡ÆÆ‡Øç ‡Æï‡Ææ‡Æü‡Øç‡Æü‡ØÅ!"
        },
        settings: {
          title: "‡ÆÖ‡ÆÆ‡Øà‡Æ™‡Øç‡Æ™‡ØÅ‡Æï‡Æ≥‡Øç",
          childName: "‡Æï‡ØÅ‡Æ¥‡Æ®‡Øç‡Æ§‡Øà‡ÆØ‡Æø‡Æ©‡Øç ‡Æ™‡ØÜ‡ÆØ‡Æ∞‡Øç",
          enterName: "‡Æ™‡ØÜ‡ÆØ‡Æ∞‡Øç ‡Æé‡Æ¥‡ØÅ‡Æ§‡ØÅ",
          stars: "‡Æ®‡Æü‡Øç‡Æö‡Æ§‡Øç‡Æ§‡Æø‡Æ∞‡Æô‡Øç‡Æï‡Æ≥‡Øç",
          streak: "‡Æ∏‡Øç‡Æü‡Øç‡Æ∞‡ØÄ‡Æï‡Øç",
          testVoice: "‡Æï‡ØÅ‡Æ∞‡Æ≤‡Øç ‡Æö‡Øã‡Æ§‡Æ©‡Øà",
          showApi: "API ‡ÆÖ‡ÆÆ‡Øà‡Æ™‡Øç‡Æ™‡ØÅ‡Æï‡Æ≥‡Øç ‡Æï‡Ææ‡Æü‡Øç‡Æü‡ØÅ",
          hideApi: "API ‡ÆÖ‡ÆÆ‡Øà‡Æ™‡Øç‡Æ™‡ØÅ‡Æï‡Æ≥‡Øç ‡ÆÆ‡Æ±‡Øà",
          currentSetup: "‡Æ§‡Æ±‡Øç‡Æ™‡Øã‡Æ§‡Øà‡ÆØ ‡ÆÖ‡ÆÆ‡Øà‡Æ™‡Øç‡Æ™‡ØÅ",
          ai: "AI",
          voice: "‡Æï‡ØÅ‡Æ∞‡Æ≤‡Øç",
          language: "‡ÆÆ‡Øä‡Æ¥‡Æø",
          demoMode: "‡Æü‡ØÜ‡ÆÆ‡Øã ‡ÆÆ‡Øã‡Æü‡Øç",
          browserTts: "‡Æ™‡Æø‡Æ∞‡Æµ‡ØÅ‡Æö‡Æ∞‡Øç TTS",
          chooseVoice: "‡Æï‡ØÅ‡Æ∞‡Æ≤‡Øç ‡Æ§‡Øá‡Æ∞‡Øç‡Æµ‡ØÅ:",
          chooseLanguage: "‡ÆÆ‡Øä‡Æ¥‡Æø ‡Æ§‡Øá‡Æ∞‡Øç‡Æµ‡ØÅ:",
          saveSettings: "‡Æö‡Øá‡ÆÆ‡Æø",
          apiKeyHint: "elevenlabs.io ‡Æá‡Æ≤‡Øç API Key ‡Æé‡Æü‡ØÅ‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç"
        }
      },
      ur: {
        greeting: "ÿßŸÑÿ≥ŸÑÿßŸÖ ÿπŸÑ€å⁄©ŸÖ ÿØŸàÿ≥ÿ™! ÿ¢ÿ¨ ⁄©⁄Ü⁄æ ŸÜ€åÿß ÿ≥€å⁄©⁄æŸÜ€í ⁄©€í ŸÑ€å€í ÿ™€åÿßÿ± €ÅŸà?",
        greetingWithName: (name) => `ÿßŸÑÿ≥ŸÑÿßŸÖ ÿπŸÑ€å⁄©ŸÖ ${name}! ÿ¢ÿ¨ ÿ≥€å⁄©⁄æŸÜ€í ⁄©€í ŸÑ€å€í ÿ™€åÿßÿ±ÿü`,
        greetings: [
          "ÿßŸÑÿ≥ŸÑÿßŸÖ ÿπŸÑ€å⁄©ŸÖ ÿØŸàÿ≥ÿ™! ÿ¢ÿ¨ ⁄©⁄Ü⁄æ ŸÜ€åÿß ÿ≥€å⁄©⁄æŸÜ€í ⁄©€í ŸÑ€å€í ÿ™€åÿßÿ± €ÅŸà?",
          "ÿ™ŸÖ ÿ¢ ⁄Øÿ¶€í! ⁄ÜŸÑŸà ŸÖÿ≤€í ÿ≥€í ÿ≥€å⁄©⁄æÿ™€í €Å€å⁄∫!",
          "€Å€åŸÑŸà ÿ≥Ÿæÿ± ÿ≥Ÿπÿßÿ±! ÿ¢ÿ¨ ⁄©€åÿß ÿ≥€å⁄©⁄æ€å⁄∫ÿü",
          "ÿ™ŸÖ€Å€å⁄∫ ÿØ€å⁄©⁄æ ⁄©ÿ± ÿ®€Åÿ™ ÿÆŸàÿ¥€å €ÅŸàÿ¶€å!"
        ],
        scanButton: "€ÅŸàŸÖ Ÿàÿ±⁄© ÿ≥⁄©€åŸÜ ⁄©ÿ±Ÿà",
        scanSubtext: "ÿßŸæŸÜ€å Ÿàÿ±⁄© ÿ¥€åŸπ ⁄©€å ÿ™ÿµŸà€åÿ± ŸÑŸà",
        cameraTitle: "ÿßŸæŸÜÿß €ÅŸàŸÖ Ÿàÿ±⁄© ÿØ⁄©⁄æÿßÿ§",
        cameraNotAvailable: "⁄©€åŸÖÿ±€Å ÿØÿ≥ÿ™€åÿßÿ® ŸÜ€Å€å⁄∫",
        uploadInstead: "ÿ®ÿ±ÿß€Å ⁄©ÿ±ŸÖ ÿ™ÿµŸà€åÿ± ÿßŸæŸÑŸà⁄à ⁄©ÿ±€å⁄∫",
        scanning: {
          looking: "Ÿàÿ≥⁄©ÿ±ÿ≤ ÿ™ŸÖ€Åÿßÿ±ÿß €ÅŸàŸÖ Ÿàÿ±⁄© ÿØ€å⁄©⁄æ ÿ±€Åÿß €Å€í...",
          starting: "ÿßŸæŸÜÿß ⁄Üÿ¥ŸÖ€Å ŸÑ⁄Øÿß ÿ±€Åÿß €ÅŸà⁄∫...",
          reading: "ÿßŸÑŸÅÿßÿ∏ ÿßŸàÿ± ŸÜŸÖÿ®ÿ± Ÿæ⁄ë⁄æ ÿ±€Åÿß €ÅŸà⁄∫...",
          found: "ŸÖŸÑ ⁄Ø€åÿß! ÿ≥Ÿà⁄Ü ÿ±€Åÿß €ÅŸà⁄∫ ⁄©€åÿ≥€í ŸÖÿØÿØ ⁄©ÿ±Ÿà⁄∫...",
          gotIt: "ÿ≥ŸÖÿ¨⁄æ ⁄Ø€åÿß! ⁄ÜŸÑŸà ÿ≥⁄©⁄æÿßÿ™ÿß €ÅŸà⁄∫!",
          couldntRead: "Ÿπ⁄æ€å⁄© ÿ≥€í Ÿæ⁄ë⁄æ ŸÜ€Å€å⁄∫ Ÿæÿß€åÿß€î ⁄©Ÿàÿ¥ÿ¥ ⁄©ÿ±ÿ™ÿß €ÅŸà⁄∫!",
          tryDifferent: "ÿßŸà€Å! ÿØŸàÿ≥ÿ±€í ÿ∑ÿ±€åŸÇ€í ÿ≥€í ⁄©Ÿàÿ¥ÿ¥ ⁄©ÿ±ÿ™ÿß €ÅŸà⁄∫...",
          iFound: "ŸÖÿ¨⁄æ€í ŸÖŸÑÿß:"
        },
        lesson: {
          back: "Ÿæ€å⁄Ü⁄æ€í",
          next: "ÿ¢⁄Ø€í",
          finish: "ÿÆÿ™ŸÖ!",
          tryAgain: "ÿØŸàÿ®ÿßÿ±€Å"
        },
        celebration: {
          amazing: "ÿ¥ÿßÿ®ÿßÿ¥!",
          earned: "ÿ™ŸÖ ŸÜ€í 3 ÿ≥ÿ™ÿßÿ±€í ÿ¨€åÿ™€í!",
          letMeSee: "Ÿàÿß€Å! ŸÖÿ¨⁄æ€í ÿßŸæŸÜÿß €ÅŸàŸÖ Ÿàÿ±⁄© ÿØ⁄©⁄æÿßÿ§!"
        },
        settings: {
          title: "ÿ™ÿ±ÿ™€åÿ®ÿßÿ™",
          childName: "ÿ®⁄Ü€í ⁄©ÿß ŸÜÿßŸÖ",
          enterName: "ŸÜÿßŸÖ ŸÑ⁄©⁄æŸà",
          stars: "ÿ≥ÿ™ÿßÿ±€í",
          streak: "ÿ≥Ÿπÿ±€å⁄©",
          testVoice: "ÿ¢Ÿàÿßÿ≤ Ÿπ€åÿ≥Ÿπ ⁄©ÿ±Ÿà",
          showApi: "API ÿ™ÿ±ÿ™€åÿ®ÿßÿ™ ÿØ⁄©⁄æÿßÿ§",
          hideApi: "API ÿ™ÿ±ÿ™€åÿ®ÿßÿ™ ⁄Ü⁄æŸæÿßÿ§",
          currentSetup: "ŸÖŸàÿ¨ŸàÿØ€Å ÿ≥€åŸπ ÿßŸæ",
          ai: "AI",
          voice: "ÿ¢Ÿàÿßÿ≤",
          language: "ÿ≤ÿ®ÿßŸÜ",
          demoMode: "⁄à€åŸÖŸà ŸÖŸà⁄à",
          browserTts: "ÿ®ÿ±ÿßÿ§ÿ≤ÿ± TTS",
          chooseVoice: "ÿ¢Ÿàÿßÿ≤ ⁄ÜŸÜŸà:",
          chooseLanguage: "ÿ≤ÿ®ÿßŸÜ ⁄ÜŸÜŸà:",
          saveSettings: "ŸÖÿ≠ŸÅŸàÿ∏ ⁄©ÿ±Ÿà",
          apiKeyHint: "elevenlabs.io ÿ≥€í API Key ŸÑŸà"
        }
      }
    };

    // Fallback to English for unsupported languages
    const getTranslation = (lang) => TRANSLATIONS[lang] || TRANSLATIONS.en;

    // ============== SETTINGS SCREEN ==============
    const SettingsScreen = ({ profile, setProfile, stars, streak, onBack }) => {
      const { settings, updateSettings } = useSettings();
      const t = getTranslation(settings.language);
      const [name, setName] = useState(profile.name || '');
      const [openaiKey, setOpenaiKey] = useState(settings.openaiKey || '');
      const [elevenlabsKey, setElevenlabsKey] = useState(settings.elevenlabsKey || '');
      const [selectedVoice, setSelectedVoice] = useState(settings.elevenlabsVoiceId || 'EXAVITQu4vr4xnSDxMaL');
      const [selectedLanguage, setSelectedLanguage] = useState(settings.language || 'en');
      const [showAdvanced, setShowAdvanced] = useState(false);
      const [testStatus, setTestStatus] = useState('');
      const { speak } = useTextToSpeech();
      
      const saveName = () => setProfile({ ...profile, name: name });
      
      const saveOpenAI = () => {
        updateSettings({ 
          openaiKey: openaiKey,
          useDemoMode: !openaiKey 
        });
        alert(openaiKey ? '‚úÖ ChatGPT enabled!' : 'Demo mode enabled');
      };
      
      const saveElevenLabs = () => {
        updateSettings({ 
          elevenlabsKey: elevenlabsKey,
          elevenlabsVoiceId: selectedVoice,
          language: selectedLanguage,
          useElevenlabs: !!elevenlabsKey 
        });
        alert(elevenlabsKey ? '‚úÖ ElevenLabs voice enabled!' : 'Browser voice enabled');
      };
      
      const handleVoiceChange = (voiceId) => {
        setSelectedVoice(voiceId);
        updateSettings({ elevenlabsVoiceId: voiceId });
      };
      
      const handleLanguageChange = (langId) => {
        setSelectedLanguage(langId);
        updateSettings({ language: langId });
      };
      
      // Direct test function that uses current input values (not saved settings)
      const testVoiceDirectly = async () => {
        if (!elevenlabsKey) {
          setTestStatus('‚ùå Please enter your ElevenLabs API key first!');
          return;
        }
        
        const voiceName = VOICE_OPTIONS.find(v => v.id === selectedVoice)?.name || 'Unknown';
        const langOption = LANGUAGE_OPTIONS.find(l => l.id === selectedLanguage);
        const testPhrase = langOption?.testPhrase || "Hi! I'm Whiskers!";
        
        setTestStatus(`‚è≥ Testing "${voiceName}" in ${langOption?.name || 'English'}...`);
        
        try {
          const response = await fetch(
            `https://api.elevenlabs.io/v1/text-to-speech/${selectedVoice}`,
            {
              method: 'POST',
              headers: {
                'Accept': 'audio/mpeg',
                'Content-Type': 'application/json',
                'xi-api-key': elevenlabsKey
              },
              body: JSON.stringify({
                text: testPhrase,
                model_id: 'eleven_turbo_v2_5',
                voice_settings: {
                  stability: 0.5,
                  similarity_boost: 0.75
                }
              })
            }
          );
          
          if (!response.ok) {
            const errorText = await response.text();
            let errorMessage = `Error ${response.status}`;
            try {
              const errorJson = JSON.parse(errorText);
              errorMessage = errorJson.detail?.message || errorJson.detail || errorJson.message || errorText;
            } catch {
              errorMessage = errorText;
            }
            
            setTestStatus(`‚ùå Error ${response.status}: ${errorMessage}`);
            return;
          }
          
          const audioBlob = await response.blob();
          const audioUrl = URL.createObjectURL(audioBlob);
          const audio = new Audio(audioUrl);
          
          audio.onerror = (e) => {
            setTestStatus('‚ùå Error playing audio');
          };
          
          audio.onended = () => {
            setTestStatus(`‚úÖ "${voiceName}" working in ${langOption?.name || 'English'}!`);
          };
          
          await audio.play();
          setTestStatus(`üîä Playing "${voiceName}" in ${langOption?.name || 'English'}...`);
          
        } catch (error) {
          setTestStatus(`‚ùå Network error: ${error.message}`);
        }
      };
      
      const testVoice = () => {
        speak("Hello! I'm Whiskers, your learning friend! Let's have fun together!");
      };
      
      return (
        <div style={{
          width: '100%',
          height: '100%',
          background: 'linear-gradient(180deg, #FFF8F0 0%, #FFF5E8 100%)',
          display: 'flex',
          flexDirection: 'column',
          overflow: 'auto'
        }}>
          <div style={{
            padding: '14px 20px',
            display: 'flex',
            alignItems: 'center',
            gap: '14px',
            borderBottom: '2px solid #FFE4D6'
          }}>
            <button onClick={onBack} style={{
              background: '#FFE4D6',
              border: 'none',
              borderRadius: '10px',
              padding: '8px 14px',
              fontSize: '15px',
              cursor: 'pointer',
              color: '#FF8B5E'
            }}>‚Üê {t.lesson.back}</button>
            <h1 style={{ fontSize: '22px', color: '#5D4E4E' }}>{t.settings.title}</h1>
          </div>
          
          <div style={{ flex: 1, padding: '20px', display: 'flex', flexDirection: 'column', alignItems: 'center', gap: '16px' }}>
            <WhiskersCat mood="happy" size={100} />
            
            {/* Name */}
            <div style={{ background: 'white', borderRadius: '16px', padding: '16px', width: '100%', maxWidth: '380px', boxShadow: '0 2px 8px rgba(0,0,0,0.05)' }}>
              <label style={{ display: 'block', fontSize: '14px', color: '#888', marginBottom: '6px' }}>{t.settings.childName}</label>
              <input
                type="text"
                value={name}
                onChange={(e) => setName(e.target.value)}
                onBlur={saveName}
                placeholder={t.settings.enterName}
                style={{ width: '100%', padding: '12px', fontSize: '18px', border: '2px solid #FFE4D6', borderRadius: '10px', outline: 'none' }}
              />
            </div>
            
            {/* Stats */}
            <div style={{ display: 'flex', gap: '12px', width: '100%', maxWidth: '380px' }}>
              <div style={{ flex: 1, background: 'rgba(255,213,79,0.2)', borderRadius: '16px', padding: '14px', textAlign: 'center' }}>
                <div style={{ fontSize: '32px' }}>‚≠ê</div>
                <div style={{ fontSize: '24px', fontWeight: 'bold', color: '#FFB300' }}>{stars}</div>
                <div style={{ color: '#888', fontSize: '12px' }}>{t.settings.stars}</div>
              </div>
              <div style={{ flex: 1, background: 'rgba(255,139,94,0.2)', borderRadius: '16px', padding: '14px', textAlign: 'center' }}>
                <div style={{ fontSize: '32px' }}>üî•</div>
                <div style={{ fontSize: '24px', fontWeight: 'bold', color: '#FF8B5E' }}>{streak}</div>
                <div style={{ color: '#888', fontSize: '12px' }}>{t.settings.streak}</div>
              </div>
            </div>
            
            {/* Voice Test */}
            <button onClick={testVoice} style={{
              background: 'linear-gradient(135deg, #9C27B0, #7B1FA2)',
              border: 'none',
              borderRadius: '16px',
              padding: '14px 28px',
              color: 'white',
              fontSize: '16px',
              cursor: 'pointer',
              display: 'flex',
              alignItems: 'center',
              gap: '8px',
              boxShadow: '0 4px 12px rgba(156,39,176,0.3)'
            }}>
              üéôÔ∏è {t.settings.testVoice}
            </button>
            
            {/* Advanced Settings Toggle */}
            <button 
              onClick={() => setShowAdvanced(!showAdvanced)}
              style={{
                background: 'transparent',
                border: '2px solid #DDD',
                borderRadius: '12px',
                padding: '10px 20px',
                color: '#666',
                fontSize: '14px',
                cursor: 'pointer'
              }}
            >
              {showAdvanced ? `‚ñº ${t.settings.hideApi}` : `‚ñ∂ ${t.settings.showApi}`}
            </button>
            
            {showAdvanced && (
              <>
                {/* ChatGPT API */}
                <div style={{ background: 'white', borderRadius: '16px', padding: '16px', width: '100%', maxWidth: '380px', boxShadow: '0 2px 8px rgba(0,0,0,0.05)' }}>
                  <div style={{ display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '10px' }}>
                    <span style={{ fontSize: '20px' }}>ü§ñ</span>
                    <span style={{ fontWeight: '500', color: '#5D4E4E' }}>ChatGPT (for AI lessons)</span>
                  </div>
                  <input
                    type="password"
                    value={openaiKey}
                    onChange={(e) => setOpenaiKey(e.target.value)}
                    placeholder="sk-..."
                    style={{ width: '100%', padding: '10px', fontSize: '14px', border: '2px solid #E3F2FD', borderRadius: '8px', outline: 'none', marginBottom: '10px' }}
                  />
                  <button onClick={saveOpenAI} style={{
                    width: '100%',
                    padding: '10px',
                    background: '#4CAF50',
                    color: 'white',
                    border: 'none',
                    borderRadius: '8px',
                    fontSize: '14px',
                    cursor: 'pointer'
                  }}>Save ChatGPT Key</button>
                  <p style={{ fontSize: '11px', color: '#888', marginTop: '6px' }}>
                    Get from platform.openai.com ‚Üí API Keys
                  </p>
                </div>
                
                {/* ElevenLabs API */}
                <div style={{ background: 'white', borderRadius: '16px', padding: '16px', width: '100%', maxWidth: '380px', boxShadow: '0 2px 8px rgba(0,0,0,0.05)' }}>
                  <div style={{ display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '10px' }}>
                    <span style={{ fontSize: '20px' }}>üéôÔ∏è</span>
                    <span style={{ fontWeight: '500', color: '#5D4E4E' }}>ElevenLabs (realistic voice)</span>
                  </div>
                  <input
                    type="password"
                    value={elevenlabsKey}
                    onChange={(e) => setElevenlabsKey(e.target.value)}
                    placeholder="Enter API key"
                    style={{ width: '100%', padding: '10px', fontSize: '14px', border: '2px solid #F3E5F5', borderRadius: '8px', outline: 'none', marginBottom: '10px' }}
                  />
                  
                  {/* Voice Selector */}
                  <label style={{ display: 'block', fontSize: '13px', color: '#666', marginBottom: '6px' }}>
                    {t.settings.chooseVoice}
                  </label>
                  <div style={{ display: 'flex', gap: '8px', marginBottom: '10px' }}>
                    <select
                      value={selectedVoice}
                      onChange={(e) => handleVoiceChange(e.target.value)}
                      style={{
                        flex: 1,
                        padding: '10px',
                        fontSize: '14px',
                        border: '2px solid #F3E5F5',
                        borderRadius: '8px',
                        outline: 'none',
                        background: 'white',
                        cursor: 'pointer'
                      }}
                    >
                      {VOICE_OPTIONS.map(voice => (
                        <option key={voice.id} value={voice.id}>
                          {voice.name} - {voice.desc}
                        </option>
                      ))}
                    </select>
                    <button 
                      onClick={testVoiceDirectly}
                      style={{
                        padding: '10px 14px',
                        background: '#9C27B0',
                        color: 'white',
                        border: 'none',
                        borderRadius: '8px',
                        fontSize: '14px',
                        cursor: 'pointer',
                        whiteSpace: 'nowrap'
                      }}
                    >
                      ‚ñ∂Ô∏è Test
                    </button>
                  </div>
                  
                  {/* Language Selector */}
                  <label style={{ display: 'block', fontSize: '13px', color: '#666', marginBottom: '6px' }}>
                    {t.settings.chooseLanguage}
                  </label>
                  <select
                    value={selectedLanguage}
                    onChange={(e) => handleLanguageChange(e.target.value)}
                    style={{
                      width: '100%',
                      padding: '10px',
                      fontSize: '14px',
                      border: '2px solid #E1BEE7',
                      borderRadius: '8px',
                      outline: 'none',
                      background: 'white',
                      cursor: 'pointer',
                      marginBottom: '10px'
                    }}
                  >
                    {LANGUAGE_OPTIONS.map(lang => (
                      <option key={lang.id} value={lang.id}>
                        {lang.name}
                      </option>
                    ))}
                  </select>
                  
                  {/* Status Display */}
                  {testStatus && (
                    <div style={{
                      padding: '10px 14px',
                      marginBottom: '10px',
                      borderRadius: '8px',
                      fontSize: '14px',
                      background: testStatus.startsWith('‚úÖ') ? '#E8F5E9' : 
                                  testStatus.startsWith('‚ùå') ? '#FFEBEE' : 
                                  testStatus.startsWith('üîä') ? '#E3F2FD' : '#FFF8E1',
                      color: testStatus.startsWith('‚úÖ') ? '#2E7D32' : 
                             testStatus.startsWith('‚ùå') ? '#C62828' : 
                             testStatus.startsWith('üîä') ? '#1565C0' : '#F57F17',
                      wordBreak: 'break-word'
                    }}>
                      {testStatus}
                    </div>
                  )}
                  
                  <button onClick={saveElevenLabs} style={{
                    width: '100%',
                    padding: '10px',
                    background: '#4CAF50',
                    color: 'white',
                    border: 'none',
                    borderRadius: '8px',
                    fontSize: '14px',
                    cursor: 'pointer'
                  }}>üíæ {t.settings.saveSettings}</button>
                  <p style={{ fontSize: '11px', color: '#888', marginTop: '6px' }}>
                    Get from elevenlabs.io ‚Üí Profile ‚Üí API Key (free tier: 10,000 chars/month)
                  </p>
                </div>
              </>
            )}
            
            {/* Current Status */}
            <div style={{ background: 'rgba(129,199,132,0.2)', borderRadius: '12px', padding: '14px 18px', maxWidth: '380px', width: '100%' }}>
              <p style={{ fontSize: '14px', color: '#5D4E4E', lineHeight: 1.5, margin: 0 }}>
                <strong>{t.settings.currentSetup}:</strong><br/>
                ü§ñ {t.settings.ai}: {settings.useDemoMode ? t.settings.demoMode : 'ChatGPT'}<br/>
                üéôÔ∏è {t.settings.voice}: {settings.useElevenlabs && settings.elevenlabsKey 
                  ? `ElevenLabs (${VOICE_OPTIONS.find(v => v.id === settings.elevenlabsVoiceId)?.name || 'Sarah'})` 
                  : t.settings.browserTts}<br/>
                üåê {t.settings.language}: {LANGUAGE_OPTIONS.find(l => l.id === settings.language)?.name || 'English'}
              </p>
            </div>
          </div>
        </div>
      );
    };

    // ============== MAIN APP ==============
    const AppContent = () => {
      const [screen, setScreen] = useState('home');
      const [capturedImage, setCapturedImage] = useState(null);
      const [lessonData, setLessonData] = useState(null);
      const [profile, setProfile] = useLocalStorage('whiskers_profile', { name: '' });
      const [stars, setStars] = useLocalStorage('whiskers_stars', 0);
      const [streak, setStreak] = useLocalStorage('whiskers_streak', 1);
      
      const addStars = (count) => setStars(stars + count);
      
      return (
        <div style={{ width: '100%', height: '100vh', overflow: 'hidden' }}>
          {screen === 'home' && (
            <HomeScreen
              profile={profile}
              stars={stars}
              streak={streak}
              onScan={() => setScreen('camera')}
              onProfile={() => setScreen('settings')}
            />
          )}
          
          {screen === 'camera' && (
            <CameraScreen
              onCapture={(image) => { setCapturedImage(image); setScreen('scanning'); }}
              onBack={() => setScreen('home')}
            />
          )}
          
          {screen === 'scanning' && (
            <ScanningScreen
              image={capturedImage}
              onComplete={(data) => { setLessonData(data); setScreen('lesson'); }}
              onBack={() => setScreen('camera')}
            />
          )}
          
          {screen === 'lesson' && lessonData && (
            <LessonScreen
              data={lessonData}
              onComplete={() => { setLessonData(null); setCapturedImage(null); setScreen('home'); }}
              onBack={() => setScreen('home')}
              onAddStars={addStars}
            />
          )}
          
          {screen === 'settings' && (
            <SettingsScreen
              profile={profile}
              setProfile={setProfile}
              stars={stars}
              streak={streak}
              onBack={() => setScreen('home')}
            />
          )}
        </div>
      );
    };

    const App = () => (
      <SettingsProvider>
        <AppContent />
      </SettingsProvider>
    );

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
