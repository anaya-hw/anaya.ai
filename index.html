<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Whiskers">
  <meta name="theme-color" content="#FF8B5E">
  <title>Whiskers Learning Companion</title>
  <link rel="manifest" href="manifest.json">
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.1.1/dist/tesseract.min.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body, #root { 
      width: 100%; 
      height: 100%; 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      overflow: hidden;
      touch-action: manipulation;
    }
    @keyframes blink { 0%, 50% { opacity: 1; } 51%, 100% { opacity: 0; } }
    @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-8px); } }
    @keyframes sparkle { 0%, 100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.7; transform: scale(1.2); } }
    @keyframes bounce { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
    @keyframes slideUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    @keyframes pulse { 0%, 100% { box-shadow: 0 0 0 0 rgba(255,139,94,0.4); } 50% { box-shadow: 0 0 0 15px rgba(255,139,94,0); } }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect, useRef, useCallback, createContext, useContext } = React;

    // ============================================================
    // CONFIGURATION - SET YOUR API KEYS HERE
    // ============================================================
    const CONFIG = {
      // OpenAI API Key (for ChatGPT) - get from platform.openai.com
      OPENAI_API_KEY: '',
      
      // ElevenLabs API Key (for realistic voice) - get from elevenlabs.io
      ELEVENLABS_API_KEY: '',
      
      // ElevenLabs Voice ID - some good kid-friendly options:
      // 'EXAVITQu4vr4xnSDxMaL' = Bella (warm female)
      // 'jBpfuIE2acCO8z3wKNLl' = Gigi (young female, animated)
      // 'XB0fDUnXU5powFXDhCwa' = Charlotte (warm, friendly)
      // 'pqHfZKP75CvOlQylNhV4' = Bill (friendly male)
      ELEVENLABS_VOICE_ID: 'jBpfuIE2acCO8z3wKNLl',
      
      // Set to false once you add API keys
      USE_DEMO_MODE: true,
      
      // Voice settings
      USE_ELEVENLABS: false // Set to true when you add ElevenLabs key
    };
    // ============================================================

    // ============== SETTINGS CONTEXT ==============
    const SettingsContext = createContext();

    const useSettings = () => useContext(SettingsContext);

    const SettingsProvider = ({ children }) => {
      const [settings, setSettings] = useState(() => {
        try {
          const saved = localStorage.getItem('whiskers_settings');
          return saved ? JSON.parse(saved) : {
            openaiKey: '',
            elevenlabsKey: '',
            elevenlabsVoiceId: 'jBpfuIE2acCO8z3wKNLl',
            useElevenlabs: false,
            useDemoMode: true
          };
        } catch {
          return {
            openaiKey: '',
            elevenlabsKey: '',
            elevenlabsVoiceId: 'jBpfuIE2acCO8z3wKNLl',
            useElevenlabs: false,
            useDemoMode: true
          };
        }
      });

      const updateSettings = (newSettings) => {
        const updated = { ...settings, ...newSettings };
        setSettings(updated);
        localStorage.setItem('whiskers_settings', JSON.stringify(updated));
      };

      return (
        <SettingsContext.Provider value={{ settings, updateSettings }}>
          {children}
        </SettingsContext.Provider>
      );
    };

    // ============== ANIMATED CAT COMPONENT ==============
    const WhiskersCat = ({ mood = 'happy', size = 200, isTalking = false }) => {
      const [blinkOpen, setBlinkOpen] = useState(true);
      const [tailAngle, setTailAngle] = useState(0);
      const [breathScale, setBreathScale] = useState(1);
      const [mouthOpen, setMouthOpen] = useState(false);
      const [bounceY, setBounceY] = useState(0);
      
      useEffect(() => {
        const blinkInterval = setInterval(() => {
          setBlinkOpen(false);
          setTimeout(() => setBlinkOpen(true), 150);
        }, 3000 + Math.random() * 2000);
        return () => clearInterval(blinkInterval);
      }, []);
      
      useEffect(() => {
        let frame = 0;
        const tailInterval = setInterval(() => {
          frame += 0.12;
          setTailAngle(Math.sin(frame) * 18);
        }, 50);
        return () => clearInterval(tailInterval);
      }, []);
      
      useEffect(() => {
        let frame = 0;
        const breathInterval = setInterval(() => {
          frame += 0.06;
          setBreathScale(1 + Math.sin(frame) * 0.025);
        }, 50);
        return () => clearInterval(breathInterval);
      }, []);
      
      useEffect(() => {
        if (isTalking) {
          const talkInterval = setInterval(() => setMouthOpen(prev => !prev), 120);
          return () => clearInterval(talkInterval);
        }
        setMouthOpen(false);
      }, [isTalking]);
      
      useEffect(() => {
        if (mood === 'excited' || mood === 'celebrating') {
          let frame = 0;
          const bounceInterval = setInterval(() => {
            frame += 0.25;
            setBounceY(Math.abs(Math.sin(frame)) * 12);
          }, 50);
          return () => clearInterval(bounceInterval);
        }
        setBounceY(0);
      }, [mood]);
      
      const catOrange = '#FF9B5E';
      const catCream = '#FFF5E6';
      const catStripe = '#E8855A';
      const noseColor = '#FFB5B5';
      
      const renderEyes = () => {
        const eyeY = 55;
        const leftEyeX = 70;
        const rightEyeX = 130;
        
        if (!blinkOpen) {
          return (
            <>
              <path d={`M ${leftEyeX - 12} ${eyeY} Q ${leftEyeX} ${eyeY + 8} ${leftEyeX + 12} ${eyeY}`} 
                    stroke="#333" strokeWidth="3" fill="none" strokeLinecap="round"/>
              <path d={`M ${rightEyeX - 12} ${eyeY} Q ${rightEyeX} ${eyeY + 8} ${rightEyeX + 12} ${eyeY}`} 
                    stroke="#333" strokeWidth="3" fill="none" strokeLinecap="round"/>
            </>
          );
        }
        
        if (mood === 'happy' || mood === 'celebrating') {
          return (
            <>
              <path d={`M ${leftEyeX - 12} ${eyeY + 5} Q ${leftEyeX} ${eyeY - 12} ${leftEyeX + 12} ${eyeY + 5}`} 
                    stroke="#333" strokeWidth="4" fill="none" strokeLinecap="round"/>
              <path d={`M ${rightEyeX - 12} ${eyeY + 5} Q ${rightEyeX} ${eyeY - 12} ${rightEyeX + 12} ${eyeY + 5}`} 
                    stroke="#333" strokeWidth="4" fill="none" strokeLinecap="round"/>
            </>
          );
        }
        
        if (mood === 'excited') {
          return (
            <>
              <circle cx={leftEyeX} cy={eyeY} r="14" fill="#333"/>
              <circle cx={leftEyeX - 3} cy={eyeY - 4} r="5" fill="white"/>
              <circle cx={leftEyeX + 5} cy={eyeY + 3} r="3" fill="white"/>
              <circle cx={rightEyeX} cy={eyeY} r="14" fill="#333"/>
              <circle cx={rightEyeX - 3} cy={eyeY - 4} r="5" fill="white"/>
              <circle cx={rightEyeX + 5} cy={eyeY + 3} r="3" fill="white"/>
            </>
          );
        }
        
        if (mood === 'thinking') {
          return (
            <>
              <ellipse cx={leftEyeX} cy={eyeY - 3} rx="10" ry="12" fill="white"/>
              <ellipse cx={leftEyeX + 4} cy={eyeY - 3} rx="6" ry="8" fill="#333"/>
              <circle cx={leftEyeX + 2} cy={eyeY - 5} r="2" fill="white"/>
              <ellipse cx={rightEyeX} cy={eyeY - 3} rx="10" ry="12" fill="white"/>
              <ellipse cx={rightEyeX + 4} cy={eyeY - 3} rx="6" ry="8" fill="#333"/>
              <circle cx={rightEyeX + 2} cy={eyeY - 5} r="2" fill="white"/>
            </>
          );
        }
        
        return (
          <>
            <ellipse cx={leftEyeX} cy={eyeY} rx="12" ry="14" fill="white"/>
            <ellipse cx={leftEyeX + 2} cy={eyeY} rx="8" ry="10" fill="#333"/>
            <circle cx={leftEyeX - 1} cy={eyeY - 3} r="3" fill="white"/>
            <ellipse cx={rightEyeX} cy={eyeY} rx="12" ry="14" fill="white"/>
            <ellipse cx={rightEyeX + 2} cy={eyeY} rx="8" ry="10" fill="#333"/>
            <circle cx={rightEyeX - 1} cy={eyeY - 3} r="3" fill="white"/>
          </>
        );
      };
      
      return (
        <svg 
          width={size} 
          height={size} 
          viewBox="0 0 200 200"
          style={{ 
            transform: `translateY(${-bounceY}px) scale(${breathScale})`,
            transition: 'transform 0.1s ease-out'
          }}
        >
          {mood === 'celebrating' && (
            <circle cx="100" cy="110" r="90" fill="url(#glowGradient)" opacity="0.6"/>
          )}
          
          <defs>
            <radialGradient id="glowGradient">
              <stop offset="0%" stopColor="#FFE566" stopOpacity="0.9"/>
              <stop offset="100%" stopColor="#FFE566" stopOpacity="0"/>
            </radialGradient>
          </defs>
          
          <g transform={`rotate(${tailAngle}, 150, 160)`}>
            <path d="M 145 155 Q 180 140 185 100 Q 190 80 175 70" 
                  stroke={catOrange} strokeWidth="18" fill="none" strokeLinecap="round"/>
            <path d="M 175 75 Q 172 68 178 65" 
                  stroke={catStripe} strokeWidth="6" fill="none" strokeLinecap="round"/>
          </g>
          
          <ellipse cx="100" cy="150" rx="55" ry="40" fill={catOrange}/>
          <ellipse cx="100" cy="155" rx="40" ry="28" fill={catCream}/>
          <ellipse cx="100" cy="75" rx="55" ry="50" fill={catOrange}/>
          
          <polygon points="45,45 55,0 80,35" fill={catOrange}/>
          <polygon points="55,35 60,15 72,32" fill={noseColor}/>
          <polygon points="155,45 145,0 120,35" fill={catOrange}/>
          <polygon points="145,35 140,15 128,32" fill={noseColor}/>
          
          <path d="M 85 25 Q 100 35 115 25" stroke={catStripe} strokeWidth="4" fill="none" strokeLinecap="round"/>
          <path d="M 90 35 Q 100 42 110 35" stroke={catStripe} strokeWidth="3" fill="none" strokeLinecap="round"/>
          
          <ellipse cx="100" cy="85" rx="35" ry="30" fill={catCream}/>
          {renderEyes()}
          <ellipse cx="100" cy="78" rx="8" ry="6" fill={noseColor}/>
          
          <path d={`M 100 84 L 100 ${mouthOpen ? 98 : 92}`} stroke="#333" strokeWidth="2"/>
          {mouthOpen ? (
            <ellipse cx="100" cy="96" rx="12" ry="8" fill="#FF8888"/>
          ) : (
            <>
              <path d="M 100 92 Q 88 100 82 95" stroke="#333" strokeWidth="2" fill="none"/>
              <path d="M 100 92 Q 112 100 118 95" stroke="#333" strokeWidth="2" fill="none"/>
            </>
          )}
          
          <line x1="45" y1="75" x2="20" y2="68" stroke="#333" strokeWidth="2"/>
          <line x1="45" y1="82" x2="18" y2="82" stroke="#333" strokeWidth="2"/>
          <line x1="45" y1="89" x2="20" y2="96" stroke="#333" strokeWidth="2"/>
          <line x1="155" y1="75" x2="180" y2="68" stroke="#333" strokeWidth="2"/>
          <line x1="155" y1="82" x2="182" y2="82" stroke="#333" strokeWidth="2"/>
          <line x1="155" y1="89" x2="180" y2="96" stroke="#333" strokeWidth="2"/>
          
          <ellipse cx="62" cy="88" rx="10" ry="6" fill="#FFB5B5" opacity="0.5"/>
          <ellipse cx="138" cy="88" rx="10" ry="6" fill="#FFB5B5" opacity="0.5"/>
        </svg>
      );
    };

    // ============== SPEECH BUBBLE ==============
    const SpeechBubble = ({ text, instant = false }) => {
      const [displayText, setDisplayText] = useState(instant ? text : '');
      
      useEffect(() => {
        if (instant) {
          setDisplayText(text);
          return;
        }
        setDisplayText('');
        let i = 0;
        const interval = setInterval(() => {
          if (i < text.length) {
            setDisplayText(text.slice(0, i + 1));
            i++;
          } else {
            clearInterval(interval);
          }
        }, 25);
        return () => clearInterval(interval);
      }, [text, instant]);
      
      return (
        <div style={{
          background: 'white',
          borderRadius: '24px',
          padding: '18px 24px',
          boxShadow: '0 4px 20px rgba(0,0,0,0.1)',
          border: '3px solid #FFE4D6',
          maxWidth: '320px',
          position: 'relative',
          animation: 'slideUp 0.3s ease-out'
        }}>
          <p style={{
            fontSize: '20px',
            color: '#5D4E4E',
            margin: 0,
            lineHeight: 1.5
          }}>
            {displayText}
            {!instant && displayText.length < text.length && (
              <span style={{ opacity: 0.5, animation: 'blink 0.8s infinite' }}>|</span>
            )}
          </p>
          <div style={{
            position: 'absolute',
            bottom: '-12px',
            left: '50%',
            transform: 'translateX(-50%)',
            width: 0,
            height: 0,
            borderLeft: '12px solid transparent',
            borderRight: '12px solid transparent',
            borderTop: '12px solid white'
          }}/>
        </div>
      );
    };

    // ============== TEXT TO SPEECH WITH ELEVENLABS ==============
    const useTextToSpeech = () => {
      const [isSpeaking, setIsSpeaking] = useState(false);
      const audioRef = useRef(null);
      const { settings } = useSettings();
      
      const speakWithElevenLabs = useCallback(async (text) => {
        if (!settings.elevenlabsKey) {
          return false;
        }
        
        try {
          setIsSpeaking(true);
          
          const response = await fetch(
            `https://api.elevenlabs.io/v1/text-to-speech/${settings.elevenlabsVoiceId || 'jBpfuIE2acCO8z3wKNLl'}`,
            {
              method: 'POST',
              headers: {
                'Accept': 'audio/mpeg',
                'Content-Type': 'application/json',
                'xi-api-key': settings.elevenlabsKey
              },
              body: JSON.stringify({
                text: text,
                model_id: 'eleven_monolingual_v1',
                voice_settings: {
                  stability: 0.6,
                  similarity_boost: 0.85,
                  style: 0.4,
                  use_speaker_boost: true
                }
              })
            }
          );
          
          if (!response.ok) {
            throw new Error('ElevenLabs API error');
          }
          
          const audioBlob = await response.blob();
          const audioUrl = URL.createObjectURL(audioBlob);
          
          if (audioRef.current) {
            audioRef.current.pause();
          }
          
          const audio = new Audio(audioUrl);
          audioRef.current = audio;
          
          audio.onended = () => {
            setIsSpeaking(false);
            URL.revokeObjectURL(audioUrl);
          };
          
          audio.onerror = () => {
            setIsSpeaking(false);
            URL.revokeObjectURL(audioUrl);
          };
          
          await audio.play();
          return true;
          
        } catch (error) {
          console.error('ElevenLabs error:', error);
          setIsSpeaking(false);
          return false;
        }
      }, [settings]);
      
      const speakWithBrowser = useCallback((text) => {
        if ('speechSynthesis' in window) {
          window.speechSynthesis.cancel();
          const cleanText = text.replace(/[\u{1F300}-\u{1F9FF}]/gu, '');
          const utterance = new SpeechSynthesisUtterance(cleanText);
          utterance.rate = 0.85;
          utterance.pitch = 1.2;
          
          // Try to find a better voice
          const voices = window.speechSynthesis.getVoices();
          const preferredVoice = voices.find(v => 
            v.name.includes('Samantha') || 
            v.name.includes('Karen') ||
            v.name.includes('Victoria') ||
            v.name.includes('Google UK English Female')
          );
          if (preferredVoice) {
            utterance.voice = preferredVoice;
          }
          
          utterance.onstart = () => setIsSpeaking(true);
          utterance.onend = () => setIsSpeaking(false);
          utterance.onerror = () => setIsSpeaking(false);
          window.speechSynthesis.speak(utterance);
        }
      }, []);
      
      const speak = useCallback(async (text) => {
        const cleanText = text.replace(/[\u{1F300}-\u{1F9FF}]/gu, '');
        
        if (settings.useElevenlabs && settings.elevenlabsKey) {
          const success = await speakWithElevenLabs(cleanText);
          if (!success) {
            speakWithBrowser(cleanText);
          }
        } else {
          speakWithBrowser(cleanText);
        }
      }, [settings, speakWithElevenLabs, speakWithBrowser]);
      
      const stop = useCallback(() => {
        if (audioRef.current) {
          audioRef.current.pause();
          audioRef.current = null;
        }
        if ('speechSynthesis' in window) {
          window.speechSynthesis.cancel();
        }
        setIsSpeaking(false);
      }, []);
      
      return { speak, stop, isSpeaking };
    };

    // ============== LOCAL STORAGE ==============
    const useLocalStorage = (key, initialValue) => {
      const [value, setValue] = useState(() => {
        try {
          const item = localStorage.getItem(key);
          return item ? JSON.parse(item) : initialValue;
        } catch {
          return initialValue;
        }
      });
      
      const setStoredValue = (newValue) => {
        setValue(newValue);
        try {
          localStorage.setItem(key, JSON.stringify(newValue));
        } catch (e) {
          console.error('Failed to save to localStorage:', e);
        }
      };
      
      return [value, setStoredValue];
    };

    // ============== DEMO LESSONS ==============
    const generateDemoLesson = (problemText) => {
      const text = problemText.toLowerCase();
      
      const addMatch = problemText.match(/(\d+)\s*[\+\Ôºã]\s*(\d+)/);
      if (addMatch) {
        const a = parseInt(addMatch[1]);
        const b = parseInt(addMatch[2]);
        const sum = a + b;
        return {
          subject: 'Math',
          originalText: problemText,
          steps: [
            { text: `Let's solve ${a} plus ${b} together!`, emoji: 'üßÆ', type: 'intro' },
            { text: `First, let's count ${a} apples!`, emoji: 'üçé'.repeat(Math.min(a, 10)), type: 'visual' },
            { text: `Great! Now let's add ${b} more apples!`, emoji: 'üçè'.repeat(Math.min(b, 10)), type: 'visual' },
            { text: `Put them all together and count!`, emoji: 'üëÜ', type: 'action' },
            { text: `One, two, three... keep counting!`, emoji: 'üî¢', type: 'action' },
            { text: `We have ${sum} apples in total!`, emoji: 'üçé'.repeat(Math.min(sum, 10)), type: 'visual' },
            { text: `${a} plus ${b} equals ${sum}!`, emoji: '‚úÖ', type: 'answer' },
            { text: `Amazing job! You're a math superstar!`, emoji: '‚≠ê', type: 'celebrate' }
          ]
        };
      }
      
      const subMatch = problemText.match(/(\d+)\s*[\-\‚àí]\s*(\d+)/);
      if (subMatch) {
        const a = parseInt(subMatch[1]);
        const b = parseInt(subMatch[2]);
        const diff = Math.max(a - b, 0);
        return {
          subject: 'Math',
          originalText: problemText,
          steps: [
            { text: `Let's solve ${a} minus ${b} together!`, emoji: 'üßÆ', type: 'intro' },
            { text: `Start with ${a} cookies!`, emoji: 'üç™'.repeat(Math.min(a, 10)), type: 'visual' },
            { text: `Now we take away ${b} cookies...`, emoji: 'üëã', type: 'action' },
            { text: `Bye bye cookies!`, emoji: 'üç™'.repeat(Math.min(b, 10)) + '‚û°Ô∏è', type: 'visual' },
            { text: `How many cookies are left?`, emoji: 'ü§î', type: 'think' },
            { text: `Count what's left: ${diff} cookies!`, emoji: 'üç™'.repeat(Math.min(diff, 10)), type: 'visual' },
            { text: `${a} minus ${b} equals ${diff}!`, emoji: '‚úÖ', type: 'answer' },
            { text: `You did it! Super work!`, emoji: '‚≠ê', type: 'celebrate' }
          ]
        };
      }
      
      const numbers = problemText.match(/\d+/g);
      if (numbers && numbers.length >= 1) {
        return {
          subject: 'Math',
          originalText: problemText,
          steps: [
            { text: `I see some numbers! Let's figure this out!`, emoji: 'üî¢', type: 'intro' },
            { text: `I found: ${numbers.join(', ')}`, emoji: 'üëÄ', type: 'visual' },
            { text: `Let's think about what to do with these numbers.`, emoji: 'ü§î', type: 'think' },
            { text: `Are we adding? Or subtracting? Let's see!`, emoji: '‚ûï‚ûñ', type: 'action' },
            { text: `Try counting on your fingers!`, emoji: 'üñêÔ∏è', type: 'action' },
            { text: `You're doing great! Keep thinking!`, emoji: 'üí™', type: 'encourage' },
            { text: `Wonderful work trying this problem!`, emoji: '‚≠ê', type: 'celebrate' }
          ]
        };
      }
      
      if (text.length > 0 && text.length < 50) {
        return {
          subject: 'Reading',
          originalText: problemText,
          steps: [
            { text: `Let's read together!`, emoji: 'üìö', type: 'intro' },
            { text: `I see: "${problemText.trim()}"`, emoji: 'üëÄ', type: 'visual' },
            { text: `Let's sound it out slowly...`, emoji: 'üó£Ô∏è', type: 'action' },
            { text: `Listen carefully to each sound!`, emoji: 'üëÇ', type: 'action' },
            { text: `Now say it with me!`, emoji: 'üé§', type: 'action' },
            { text: `Great job sounding it out!`, emoji: 'üëè', type: 'celebrate' },
            { text: `You're becoming a great reader!`, emoji: '‚≠ê', type: 'celebrate' }
          ]
        };
      }
      
      return {
        subject: 'Learning',
        originalText: problemText,
        steps: [
          { text: `Let's look at this together!`, emoji: 'üìù', type: 'intro' },
          { text: `Hmm, let me see what we have here...`, emoji: 'üîç', type: 'visual' },
          { text: `Let's break it into small parts!`, emoji: '‚úÇÔ∏è', type: 'action' },
          { text: `Think about what you already know!`, emoji: 'ü§î', type: 'think' },
          { text: `You're doing great! Keep trying!`, emoji: 'üí™', type: 'encourage' },
          { text: `Excellent effort! I'm proud of you!`, emoji: '‚≠ê', type: 'celebrate' }
        ]
      };
    };

    // ============== CHATGPT AI LESSON GENERATION ==============
    const generateAiLesson = async (problemText, settings) => {
      if (settings.useDemoMode || !settings.openaiKey) {
        console.log('Using demo mode');
        return generateDemoLesson(problemText);
      }
      
      console.log('Calling ChatGPT API...');
      
      try {
        const response = await fetch('https://api.openai.com/v1/chat/completions', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${settings.openaiKey}`
          },
          body: JSON.stringify({
            model: 'gpt-4o-mini',
            messages: [{
              role: 'system',
              content: `You are Whiskers, a friendly cat teacher helping kindergarteners (age 5-6) with homework. 
You must respond with ONLY valid JSON, no markdown or code blocks.
Be warm, encouraging, patient, and use simple words a 5-year-old understands.`
            }, {
              role: 'user',
              content: `The student's homework says: "${problemText}"

Create a fun lesson. Respond with ONLY this JSON format:
{"subject":"Math or Reading","steps":[{"text":"short sentence under 12 words","emoji":"emojis","type":"intro or visual or action or think or answer or celebrate"}]}

Rules:
- 6-8 simple steps
- Use counting objects for math (apples, cookies, stars)
- Be very encouraging
- End with celebration`
            }],
            temperature: 0.7,
            max_tokens: 800
          })
        });
        
        if (!response.ok) {
          const errorText = await response.text();
          console.error('OpenAI API Error:', response.status, errorText);
          throw new Error(`API error: ${response.status}`);
        }
        
        const data = await response.json();
        console.log('ChatGPT response:', data);
        
        let content = data.choices[0].message.content;
        // Clean up potential markdown formatting
        content = content.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
        
        const lesson = JSON.parse(content);
        lesson.originalText = problemText;
        return lesson;
        
      } catch (error) {
        console.error('AI lesson error:', error);
        return generateDemoLesson(problemText);
      }
    };

    // ============== HOME SCREEN ==============
    const HomeScreen = ({ profile, stars, streak, onScan, onProfile }) => {
      const [dialogue, setDialogue] = useState("Hi there, friend! Ready to learn something amazing today?");
      const [catMood, setCatMood] = useState('happy');
      const { speak, isSpeaking } = useTextToSpeech();
      const { settings } = useSettings();
      
      const greetings = [
        "Hi there, friend! Ready to learn something amazing today?",
        "Yay, you're here! Let's have fun learning!",
        "Hello, superstar! What should we explore?",
        "I'm so happy to see you!"
      ];
      
      useEffect(() => {
        const greeting = profile.name 
          ? `Hi ${profile.name}! Ready to learn today?`
          : greetings[Math.floor(Math.random() * greetings.length)];
        setDialogue(greeting);
        setTimeout(() => speak(greeting), 500);
      }, []);
      
      const getModeLabel = () => {
        if (settings.useDemoMode) return 'üìã Demo';
        if (settings.openaiKey) return 'ü§ñ ChatGPT';
        return 'üìã Demo';
      };
      
      const getVoiceLabel = () => {
        if (settings.useElevenlabs && settings.elevenlabsKey) return 'üéôÔ∏è ElevenLabs';
        return 'üîä Browser';
      };
      
      return (
        <div style={{
          width: '100%',
          height: '100%',
          background: 'linear-gradient(180deg, #FFF8F0 0%, #FFF5E8 50%, #FFF8F0 100%)',
          display: 'flex',
          flexDirection: 'column',
          overflow: 'auto'
        }}>
          {/* Header */}
          <div style={{
            display: 'flex',
            justifyContent: 'space-between',
            alignItems: 'center',
            padding: '16px 24px'
          }}>
            <div style={{ display: 'flex', gap: '12px' }}>
              <div style={{
                background: 'rgba(255,213,79,0.2)',
                borderRadius: '16px',
                padding: '10px 16px',
                display: 'flex',
                alignItems: 'center',
                gap: '6px'
              }}>
                <span style={{ fontSize: '22px', animation: 'sparkle 2s infinite' }}>‚≠ê</span>
                <span style={{ fontSize: '20px', fontWeight: 'bold', color: '#FFB300' }}>{stars}</span>
              </div>
              <div style={{
                background: 'rgba(255,139,94,0.2)',
                borderRadius: '16px',
                padding: '10px 16px',
                display: 'flex',
                alignItems: 'center',
                gap: '6px'
              }}>
                <span style={{ fontSize: '22px' }}>üî•</span>
                <span style={{ fontSize: '20px', fontWeight: 'bold', color: '#FF8B5E' }}>{streak}</span>
              </div>
            </div>
            
            {/* Mode indicators */}
            <div style={{ display: 'flex', gap: '8px' }}>
              <div style={{
                background: settings.useDemoMode ? 'rgba(255,193,7,0.2)' : 'rgba(76,175,80,0.2)',
                borderRadius: '10px',
                padding: '4px 10px',
                fontSize: '11px',
                color: settings.useDemoMode ? '#F57C00' : '#388E3C'
              }}>
                {getModeLabel()}
              </div>
              <div style={{
                background: settings.useElevenlabs ? 'rgba(156,39,176,0.2)' : 'rgba(158,158,158,0.2)',
                borderRadius: '10px',
                padding: '4px 10px',
                fontSize: '11px',
                color: settings.useElevenlabs ? '#7B1FA2' : '#616161'
              }}>
                {getVoiceLabel()}
              </div>
            </div>
            
            <button
              onClick={onProfile}
              style={{
                background: 'white',
                border: '2px solid #FFE4D6',
                borderRadius: '50%',
                width: '48px',
                height: '48px',
                fontSize: '22px',
                cursor: 'pointer'
              }}
            >
              ‚öôÔ∏è
            </button>
          </div>
          
          {/* Main content */}
          <div style={{
            flex: 1,
            display: 'flex',
            flexDirection: 'column',
            alignItems: 'center',
            justifyContent: 'center',
            padding: '20px',
            gap: '16px'
          }}>
            <SpeechBubble text={dialogue} />
            
            <WhiskersCat mood={catMood} size={200} isTalking={isSpeaking} />
            
            {profile.name && (
              <div style={{
                background: 'rgba(255,139,94,0.1)',
                borderRadius: '20px',
                padding: '10px 20px',
                display: 'flex',
                alignItems: 'center',
                gap: '8px'
              }}>
                <span style={{ fontSize: '24px' }}>üê±</span>
                <span style={{ fontSize: '20px', color: '#FF8B5E', fontWeight: '600' }}>
                  Hi, {profile.name}!
                </span>
              </div>
            )}
            
            {/* Scan button */}
            <button
              onClick={() => {
                setCatMood('excited');
                setDialogue("Ooh! Let me see your homework!");
                speak("Ooh! Let me see your homework!");
                setTimeout(onScan, 1500);
              }}
              style={{
                background: 'linear-gradient(135deg, #FF8B5E 0%, #FF7043 100%)',
                border: 'none',
                borderRadius: '28px',
                padding: '22px 44px',
                marginTop: '16px',
                cursor: 'pointer',
                boxShadow: '0 8px 32px rgba(255,139,94,0.4)',
                display: 'flex',
                alignItems: 'center',
                gap: '14px',
                animation: 'pulse 2s infinite'
              }}
            >
              <span style={{ fontSize: '38px' }}>üì∏</span>
              <div style={{ textAlign: 'left' }}>
                <div style={{ fontSize: '22px', color: 'white', fontWeight: 'bold' }}>
                  Scan Homework
                </div>
                <div style={{ fontSize: '13px', color: 'rgba(255,255,255,0.85)' }}>
                  Take a photo of your worksheet
                </div>
              </div>
            </button>
          </div>
        </div>
      );
    };

    // ============== CAMERA SCREEN ==============
    const CameraScreen = ({ onCapture, onBack }) => {
      const videoRef = useRef(null);
      const canvasRef = useRef(null);
      const [hasCamera, setHasCamera] = useState(true);
      const [stream, setStream] = useState(null);
      const [cameraReady, setCameraReady] = useState(false);
      const [error, setError] = useState(null);
      
      useEffect(() => {
        const startCamera = async () => {
          try {
            const mediaStream = await navigator.mediaDevices.getUserMedia({
              video: { 
                facingMode: 'environment', 
                width: { ideal: 1920 }, 
                height: { ideal: 1080 } 
              }
            });
            if (videoRef.current) {
              videoRef.current.srcObject = mediaStream;
              setStream(mediaStream);
              videoRef.current.onloadedmetadata = () => {
                setCameraReady(true);
              };
            }
          } catch (err) {
            console.error('Camera error:', err);
            setError(err.message);
            setHasCamera(false);
          }
        };
        
        startCamera();
        
        return () => {
          if (stream) {
            stream.getTracks().forEach(track => track.stop());
          }
        };
      }, []);
      
      const capturePhoto = () => {
        if (videoRef.current && canvasRef.current) {
          const video = videoRef.current;
          const canvas = canvasRef.current;
          canvas.width = video.videoWidth || 1280;
          canvas.height = video.videoHeight || 720;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(video, 0, 0);
          const imageData = canvas.toDataURL('image/jpeg', 0.9);
          
          if (stream) {
            stream.getTracks().forEach(track => track.stop());
          }
          
          onCapture(imageData);
        }
      };
      
      const handleFileUpload = (e) => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = (event) => {
            onCapture(event.target.result);
          };
          reader.readAsDataURL(file);
        }
      };
      
      return (
        <div style={{
          width: '100%',
          height: '100%',
          background: '#000',
          display: 'flex',
          flexDirection: 'column',
          position: 'relative'
        }}>
          <div style={{
            padding: '16px',
            display: 'flex',
            justifyContent: 'space-between',
            alignItems: 'center',
            background: 'rgba(0,0,0,0.5)',
            position: 'absolute',
            top: 0,
            left: 0,
            right: 0,
            zIndex: 10
          }}>
            <button
              onClick={onBack}
              style={{
                background: 'rgba(255,255,255,0.2)',
                border: 'none',
                borderRadius: '50%',
                width: '44px',
                height: '44px',
                fontSize: '24px',
                color: 'white',
                cursor: 'pointer'
              }}
            >
              ‚Üê
            </button>
            <span style={{ color: 'white', fontSize: '18px', fontWeight: '500' }}>
              üì∏ Point at your homework
            </span>
            <div style={{ width: '44px' }}></div>
          </div>
          
          {hasCamera ? (
            <video
              ref={videoRef}
              autoPlay
              playsInline
              muted
              style={{
                width: '100%',
                height: '100%',
                objectFit: 'cover'
              }}
            />
          ) : (
            <div style={{
              flex: 1,
              display: 'flex',
              flexDirection: 'column',
              alignItems: 'center',
              justifyContent: 'center',
              color: 'white',
              padding: '20px',
              textAlign: 'center'
            }}>
              <span style={{ fontSize: '60px', marginBottom: '20px' }}>üì∑</span>
              <p style={{ fontSize: '18px', marginBottom: '10px' }}>
                Camera not available
              </p>
              <p style={{ fontSize: '14px', color: '#aaa', marginBottom: '20px' }}>
                {error || 'Please upload a photo instead'}
              </p>
            </div>
          )}
          
          <canvas ref={canvasRef} style={{ display: 'none' }} />
          
          <div style={{
            position: 'absolute',
            bottom: 0,
            left: 0,
            right: 0,
            padding: '30px',
            display: 'flex',
            justifyContent: 'center',
            alignItems: 'center',
            gap: '30px',
            background: 'linear-gradient(transparent, rgba(0,0,0,0.8))'
          }}>
            <label style={{
              background: 'rgba(255,255,255,0.2)',
              border: '2px solid white',
              borderRadius: '50%',
              width: '56px',
              height: '56px',
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              fontSize: '24px',
              cursor: 'pointer'
            }}>
              üìÅ
              <input
                type="file"
                accept="image/*"
                capture="environment"
                onChange={handleFileUpload}
                style={{ display: 'none' }}
              />
            </label>
            
            {hasCamera && (
              <button
                onClick={capturePhoto}
                disabled={!cameraReady}
                style={{
                  background: cameraReady ? 'white' : '#666',
                  border: '4px solid #FF8B5E',
                  borderRadius: '50%',
                  width: '80px',
                  height: '80px',
                  cursor: cameraReady ? 'pointer' : 'not-allowed',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  fontSize: '36px'
                }}
              >
                {cameraReady ? 'üì∑' : '‚è≥'}
              </button>
            )}
            
            <label style={{
              background: '#FF8B5E',
              border: 'none',
              borderRadius: '50%',
              width: '56px',
              height: '56px',
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              fontSize: '24px',
              cursor: 'pointer'
            }}>
              üñºÔ∏è
              <input
                type="file"
                accept="image/*"
                onChange={handleFileUpload}
                style={{ display: 'none' }}
              />
            </label>
          </div>
        </div>
      );
    };

    // ============== SCANNING SCREEN ==============
    const ScanningScreen = ({ image, onComplete, onBack }) => {
      const [status, setStatus] = useState('Whiskers is looking at your homework...');
      const [progress, setProgress] = useState(0);
      const [detectedText, setDetectedText] = useState('');
      const [error, setError] = useState(null);
      const { speak, isSpeaking } = useTextToSpeech();
      const { settings } = useSettings();
      
      useEffect(() => {
        speak("Let me take a look at your homework!");
        runOCR();
      }, []);
      
      const runOCR = async () => {
        try {
          setStatus('Starting up my reading glasses...');
          setProgress(10);
          
          if (typeof Tesseract === 'undefined') {
            throw new Error('OCR library not loaded');
          }
          
          setStatus('Reading the words and numbers...');
          setProgress(30);
          
          const result = await Tesseract.recognize(
            image,
            'eng',
            {
              logger: m => {
                if (m.status === 'recognizing text') {
                  setProgress(30 + Math.round(m.progress * 40));
                }
              }
            }
          );
          
          const text = result.data.text.trim();
          console.log('OCR Result:', text);
          setDetectedText(text);
          
          setProgress(75);
          setStatus('Found it! Now thinking about how to help...');
          
          if (!text) {
            setStatus("Hmm, I couldn't read that clearly. Let me try my best!");
          }
          
          setProgress(85);
          const lesson = await generateAiLesson(text || '5 + 3 = ?', settings);
          
          setProgress(100);
          setStatus('Got it! Let me teach you!');
          speak("Got it! Let me teach you!");
          
          setTimeout(() => {
            onComplete({
              originalText: text || 'Could not read clearly',
              lesson: lesson
            });
          }, 1500);
          
        } catch (err) {
          console.error('OCR Error:', err);
          setError(err.message);
          setStatus("Oops! Let me try a different way...");
          
          setTimeout(async () => {
            const lesson = generateDemoLesson('3 + 2 = ?');
            onComplete({
              originalText: 'Demo problem: 3 + 2 = ?',
              lesson: lesson
            });
          }, 2000);
        }
      };
      
      return (
        <div style={{
          width: '100%',
          height: '100%',
          background: 'linear-gradient(180deg, #FFF8F0 0%, #FFF5E8 100%)',
          display: 'flex',
          flexDirection: 'column',
          alignItems: 'center',
          justifyContent: 'center',
          padding: '24px'
        }}>
          <WhiskersCat mood="thinking" size={160} isTalking={isSpeaking} />
          
          <div style={{ marginTop: '20px', textAlign: 'center', width: '100%', maxWidth: '360px' }}>
            <p style={{ fontSize: '20px', color: '#5D4E4E', marginBottom: '16px' }}>
              {status}
            </p>
            
            <div style={{
              width: '100%',
              height: '14px',
              background: '#FFE4D6',
              borderRadius: '7px',
              overflow: 'hidden',
              marginBottom: '16px'
            }}>
              <div style={{
                width: `${progress}%`,
                height: '100%',
                background: 'linear-gradient(90deg, #FF8B5E, #FFB74D)',
                borderRadius: '7px',
                transition: 'width 0.5s ease-out'
              }} />
            </div>
            
            {detectedText && (
              <div style={{
                background: 'white',
                borderRadius: '12px',
                padding: '12px 16px',
                marginBottom: '16px',
                border: '2px solid #E8F5E9'
              }}>
                <p style={{ fontSize: '12px', color: '#888', marginBottom: '4px' }}>
                  üìù I found:
                </p>
                <p style={{ fontSize: '16px', color: '#333' }}>
                  {detectedText.slice(0, 100)}{detectedText.length > 100 ? '...' : ''}
                </p>
              </div>
            )}
          </div>
          
          <div style={{
            width: '160px',
            height: '120px',
            borderRadius: '12px',
            overflow: 'hidden',
            border: '3px solid #FFE4D6',
            boxShadow: '0 4px 12px rgba(0,0,0,0.1)'
          }}>
            <img src={image} alt="Homework" style={{ width: '100%', height: '100%', objectFit: 'cover' }} />
          </div>
          
          <button
            onClick={onBack}
            style={{
              marginTop: '16px',
              background: 'transparent',
              border: '2px solid #FF8B5E',
              borderRadius: '16px',
              padding: '10px 20px',
              color: '#FF8B5E',
              fontSize: '15px',
              cursor: 'pointer'
            }}
          >
            ‚Üê Try again
          </button>
        </div>
      );
    };

    // ============== LESSON SCREEN ==============
    const LessonScreen = ({ data, onComplete, onBack, onAddStars }) => {
      const [currentStep, setCurrentStep] = useState(0);
      const [showCelebration, setShowCelebration] = useState(false);
      const { speak, isSpeaking } = useTextToSpeech();
      
      const steps = data.lesson.steps;
      const step = steps[currentStep];
      
      useEffect(() => {
        if (step) {
          speak(step.text);
        }
      }, [currentStep]);
      
      const nextStep = () => {
        if (currentStep < steps.length - 1) {
          setCurrentStep(currentStep + 1);
        } else {
          setShowCelebration(true);
          speak("Amazing job! You earned 3 stars!");
          onAddStars(3);
          setTimeout(onComplete, 4000);
        }
      };
      
      const prevStep = () => {
        if (currentStep > 0) setCurrentStep(currentStep - 1);
      };
      
      if (showCelebration) {
        return (
          <div style={{
            width: '100%',
            height: '100%',
            background: 'linear-gradient(180deg, #FFF8F0 0%, #FFFDE7 100%)',
            display: 'flex',
            flexDirection: 'column',
            alignItems: 'center',
            justifyContent: 'center'
          }}>
            <div style={{ fontSize: '70px', animation: 'bounce 0.5s infinite' }}>üéâ</div>
            <WhiskersCat mood="celebrating" size={180} isTalking={isSpeaking} />
            <h1 style={{ fontSize: '30px', color: '#FF8B5E', margin: '16px 0' }}>Amazing Job!</h1>
            <div style={{ display: 'flex', gap: '8px', marginBottom: '16px' }}>
              {[1, 2, 3].map(i => (
                <span key={i} style={{ fontSize: '44px', animation: `sparkle 0.5s ease-out ${i * 0.2}s` }}>‚≠ê</span>
              ))}
            </div>
            <p style={{ fontSize: '20px', color: '#5D4E4E' }}>You earned 3 stars!</p>
          </div>
        );
      }
      
      return (
        <div style={{
          width: '100%',
          height: '100%',
          background: 'linear-gradient(180deg, #FFF8F0 0%, #FFF5E8 100%)',
          display: 'flex',
          flexDirection: 'column'
        }}>
          <div style={{
            padding: '14px 20px',
            display: 'flex',
            justifyContent: 'space-between',
            alignItems: 'center',
            borderBottom: '2px solid #FFE4D6'
          }}>
            <button onClick={onBack} style={{
              background: '#FFE4D6',
              border: 'none',
              borderRadius: '10px',
              padding: '8px 14px',
              fontSize: '15px',
              cursor: 'pointer',
              color: '#FF8B5E'
            }}>‚Üê Back</button>
            
            <div style={{ display: 'flex', gap: '5px', flexWrap: 'wrap', justifyContent: 'center', maxWidth: '180px' }}>
              {steps.map((_, i) => (
                <div key={i} style={{
                  width: i === currentStep ? '18px' : '9px',
                  height: '9px',
                  borderRadius: '5px',
                  background: i <= currentStep ? '#FF8B5E' : '#FFE4D6',
                  transition: 'all 0.3s'
                }} />
              ))}
            </div>
            
            <div style={{
              background: '#FFE4D6',
              borderRadius: '10px',
              padding: '6px 12px',
              fontSize: '13px',
              color: '#FF8B5E'
            }}>{data.lesson.subject}</div>
          </div>
          
          <div style={{
            flex: 1,
            display: 'flex',
            flexDirection: 'column',
            alignItems: 'center',
            justifyContent: 'center',
            padding: '20px',
            gap: '14px',
            overflow: 'auto'
          }}>
            <SpeechBubble text={step.text} key={currentStep} />
            
            <WhiskersCat 
              mood={step.type === 'celebrate' ? 'celebrating' : step.type === 'think' ? 'thinking' : 'happy'} 
              size={150} 
              isTalking={isSpeaking} 
            />
            
            {step.emoji && (
              <div style={{
                fontSize: '40px',
                padding: '14px 22px',
                background: 'rgba(255,255,255,0.9)',
                borderRadius: '18px',
                boxShadow: '0 4px 12px rgba(0,0,0,0.05)',
                animation: 'float 2s ease-in-out infinite',
                letterSpacing: '3px',
                textAlign: 'center',
                maxWidth: '280px'
              }}>
                {step.emoji}
              </div>
            )}
          </div>
          
          <div style={{
            padding: '16px 20px',
            display: 'flex',
            gap: '14px',
            borderTop: '2px solid #FFE4D6'
          }}>
            <button onClick={prevStep} disabled={currentStep === 0} style={{
              flex: 1,
              background: currentStep === 0 ? '#EEE' : '#FFE4D6',
              border: 'none',
              borderRadius: '18px',
              padding: '16px',
              fontSize: '17px',
              cursor: currentStep === 0 ? 'not-allowed' : 'pointer',
              color: currentStep === 0 ? '#AAA' : '#FF8B5E'
            }}>‚Üê Back</button>
            
            <button onClick={nextStep} style={{
              flex: 2,
              background: 'linear-gradient(135deg, #FF8B5E, #FF7043)',
              border: 'none',
              borderRadius: '18px',
              padding: '16px',
              fontSize: '18px',
              cursor: 'pointer',
              color: 'white',
              fontWeight: 'bold',
              boxShadow: '0 4px 16px rgba(255,139,94,0.4)'
            }}>
              {currentStep === steps.length - 1 ? 'üéâ Finish!' : 'Next ‚Üí'}
            </button>
          </div>
        </div>
      );
    };

    // ============== SETTINGS SCREEN ==============
    const SettingsScreen = ({ profile, setProfile, stars, streak, onBack }) => {
      const { settings, updateSettings } = useSettings();
      const [name, setName] = useState(profile.name || '');
      const [openaiKey, setOpenaiKey] = useState(settings.openaiKey || '');
      const [elevenlabsKey, setElevenlabsKey] = useState(settings.elevenlabsKey || '');
      const [showAdvanced, setShowAdvanced] = useState(false);
      const { speak } = useTextToSpeech();
      
      const saveName = () => setProfile({ ...profile, name: name });
      
      const saveOpenAI = () => {
        updateSettings({ 
          openaiKey: openaiKey,
          useDemoMode: !openaiKey 
        });
        alert(openaiKey ? '‚úÖ ChatGPT enabled!' : 'Demo mode enabled');
      };
      
      const saveElevenLabs = () => {
        updateSettings({ 
          elevenlabsKey: elevenlabsKey,
          useElevenlabs: !!elevenlabsKey 
        });
        alert(elevenlabsKey ? '‚úÖ ElevenLabs voice enabled!' : 'Browser voice enabled');
      };
      
      const testVoice = () => {
        speak("Hello! I'm Whiskers, your learning friend! Let's have fun together!");
      };
      
      return (
        <div style={{
          width: '100%',
          height: '100%',
          background: 'linear-gradient(180deg, #FFF8F0 0%, #FFF5E8 100%)',
          display: 'flex',
          flexDirection: 'column',
          overflow: 'auto'
        }}>
          <div style={{
            padding: '14px 20px',
            display: 'flex',
            alignItems: 'center',
            gap: '14px',
            borderBottom: '2px solid #FFE4D6'
          }}>
            <button onClick={onBack} style={{
              background: '#FFE4D6',
              border: 'none',
              borderRadius: '10px',
              padding: '8px 14px',
              fontSize: '15px',
              cursor: 'pointer',
              color: '#FF8B5E'
            }}>‚Üê Back</button>
            <h1 style={{ fontSize: '22px', color: '#5D4E4E' }}>Settings</h1>
          </div>
          
          <div style={{ flex: 1, padding: '20px', display: 'flex', flexDirection: 'column', alignItems: 'center', gap: '16px' }}>
            <WhiskersCat mood="happy" size={100} />
            
            {/* Name */}
            <div style={{ background: 'white', borderRadius: '16px', padding: '16px', width: '100%', maxWidth: '380px', boxShadow: '0 2px 8px rgba(0,0,0,0.05)' }}>
              <label style={{ display: 'block', fontSize: '14px', color: '#888', marginBottom: '6px' }}>Child's Name</label>
              <input
                type="text"
                value={name}
                onChange={(e) => setName(e.target.value)}
                onBlur={saveName}
                placeholder="Enter name"
                style={{ width: '100%', padding: '12px', fontSize: '18px', border: '2px solid #FFE4D6', borderRadius: '10px', outline: 'none' }}
              />
            </div>
            
            {/* Stats */}
            <div style={{ display: 'flex', gap: '12px', width: '100%', maxWidth: '380px' }}>
              <div style={{ flex: 1, background: 'rgba(255,213,79,0.2)', borderRadius: '16px', padding: '14px', textAlign: 'center' }}>
                <div style={{ fontSize: '32px' }}>‚≠ê</div>
                <div style={{ fontSize: '24px', fontWeight: 'bold', color: '#FFB300' }}>{stars}</div>
                <div style={{ color: '#888', fontSize: '12px' }}>Stars</div>
              </div>
              <div style={{ flex: 1, background: 'rgba(255,139,94,0.2)', borderRadius: '16px', padding: '14px', textAlign: 'center' }}>
                <div style={{ fontSize: '32px' }}>üî•</div>
                <div style={{ fontSize: '24px', fontWeight: 'bold', color: '#FF8B5E' }}>{streak}</div>
                <div style={{ color: '#888', fontSize: '12px' }}>Streak</div>
              </div>
            </div>
            
            {/* Voice Test */}
            <button onClick={testVoice} style={{
              background: 'linear-gradient(135deg, #9C27B0, #7B1FA2)',
              border: 'none',
              borderRadius: '16px',
              padding: '14px 28px',
              color: 'white',
              fontSize: '16px',
              cursor: 'pointer',
              display: 'flex',
              alignItems: 'center',
              gap: '8px',
              boxShadow: '0 4px 12px rgba(156,39,176,0.3)'
            }}>
              üéôÔ∏è Test Voice
            </button>
            
            {/* Advanced Settings Toggle */}
            <button 
              onClick={() => setShowAdvanced(!showAdvanced)}
              style={{
                background: 'transparent',
                border: '2px solid #DDD',
                borderRadius: '12px',
                padding: '10px 20px',
                color: '#666',
                fontSize: '14px',
                cursor: 'pointer'
              }}
            >
              {showAdvanced ? '‚ñº Hide API Settings' : '‚ñ∂ Show API Settings'}
            </button>
            
            {showAdvanced && (
              <>
                {/* ChatGPT API */}
                <div style={{ background: 'white', borderRadius: '16px', padding: '16px', width: '100%', maxWidth: '380px', boxShadow: '0 2px 8px rgba(0,0,0,0.05)' }}>
                  <div style={{ display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '10px' }}>
                    <span style={{ fontSize: '20px' }}>ü§ñ</span>
                    <span style={{ fontWeight: '500', color: '#5D4E4E' }}>ChatGPT (for AI lessons)</span>
                  </div>
                  <input
                    type="password"
                    value={openaiKey}
                    onChange={(e) => setOpenaiKey(e.target.value)}
                    placeholder="sk-..."
                    style={{ width: '100%', padding: '10px', fontSize: '14px', border: '2px solid #E3F2FD', borderRadius: '8px', outline: 'none', marginBottom: '10px' }}
                  />
                  <button onClick={saveOpenAI} style={{
                    width: '100%',
                    padding: '10px',
                    background: '#4CAF50',
                    color: 'white',
                    border: 'none',
                    borderRadius: '8px',
                    fontSize: '14px',
                    cursor: 'pointer'
                  }}>Save ChatGPT Key</button>
                  <p style={{ fontSize: '11px', color: '#888', marginTop: '6px' }}>
                    Get from platform.openai.com ‚Üí API Keys
                  </p>
                </div>
                
                {/* ElevenLabs API */}
                <div style={{ background: 'white', borderRadius: '16px', padding: '16px', width: '100%', maxWidth: '380px', boxShadow: '0 2px 8px rgba(0,0,0,0.05)' }}>
                  <div style={{ display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '10px' }}>
                    <span style={{ fontSize: '20px' }}>üéôÔ∏è</span>
                    <span style={{ fontWeight: '500', color: '#5D4E4E' }}>ElevenLabs (realistic voice)</span>
                  </div>
                  <input
                    type="password"
                    value={elevenlabsKey}
                    onChange={(e) => setElevenlabsKey(e.target.value)}
                    placeholder="Enter API key"
                    style={{ width: '100%', padding: '10px', fontSize: '14px', border: '2px solid #F3E5F5', borderRadius: '8px', outline: 'none', marginBottom: '10px' }}
                  />
                  <button onClick={saveElevenLabs} style={{
                    width: '100%',
                    padding: '10px',
                    background: '#9C27B0',
                    color: 'white',
                    border: 'none',
                    borderRadius: '8px',
                    fontSize: '14px',
                    cursor: 'pointer'
                  }}>Save ElevenLabs Key</button>
                  <p style={{ fontSize: '11px', color: '#888', marginTop: '6px' }}>
                    Get from elevenlabs.io ‚Üí Profile ‚Üí API Key (free tier: 10,000 chars/month)
                  </p>
                </div>
              </>
            )}
            
            {/* Current Status */}
            <div style={{ background: 'rgba(129,199,132,0.2)', borderRadius: '12px', padding: '14px 18px', maxWidth: '380px', width: '100%' }}>
              <p style={{ fontSize: '14px', color: '#5D4E4E', lineHeight: 1.5, margin: 0 }}>
                <strong>Current Setup:</strong><br/>
                ü§ñ AI: {settings.useDemoMode ? 'Demo mode' : 'ChatGPT'}<br/>
                üéôÔ∏è Voice: {settings.useElevenlabs && settings.elevenlabsKey ? 'ElevenLabs' : 'Browser TTS'}
              </p>
            </div>
          </div>
        </div>
      );
    };

    // ============== MAIN APP ==============
    const AppContent = () => {
      const [screen, setScreen] = useState('home');
      const [capturedImage, setCapturedImage] = useState(null);
      const [lessonData, setLessonData] = useState(null);
      const [profile, setProfile] = useLocalStorage('whiskers_profile', { name: '' });
      const [stars, setStars] = useLocalStorage('whiskers_stars', 0);
      const [streak, setStreak] = useLocalStorage('whiskers_streak', 1);
      
      const addStars = (count) => setStars(stars + count);
      
      return (
        <div style={{ width: '100%', height: '100vh', overflow: 'hidden' }}>
          {screen === 'home' && (
            <HomeScreen
              profile={profile}
              stars={stars}
              streak={streak}
              onScan={() => setScreen('camera')}
              onProfile={() => setScreen('settings')}
            />
          )}
          
          {screen === 'camera' && (
            <CameraScreen
              onCapture={(image) => { setCapturedImage(image); setScreen('scanning'); }}
              onBack={() => setScreen('home')}
            />
          )}
          
          {screen === 'scanning' && (
            <ScanningScreen
              image={capturedImage}
              onComplete={(data) => { setLessonData(data); setScreen('lesson'); }}
              onBack={() => setScreen('camera')}
            />
          )}
          
          {screen === 'lesson' && lessonData && (
            <LessonScreen
              data={lessonData}
              onComplete={() => { setLessonData(null); setCapturedImage(null); setScreen('home'); }}
              onBack={() => setScreen('home')}
              onAddStars={addStars}
            />
          )}
          
          {screen === 'settings' && (
            <SettingsScreen
              profile={profile}
              setProfile={setProfile}
              stars={stars}
              streak={streak}
              onBack={() => setScreen('home')}
            />
          )}
        </div>
      );
    };

    const App = () => (
      <SettingsProvider>
        <AppContent />
      </SettingsProvider>
    );

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
